<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokyo Mini-Theater Showtimes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f3ef;
            --grid: #e0d9cf;
            --ink: #1d1b19;
            --muted: #5d564f;
            --accent: #f2c100;
            --accent-strong: #c79400;
            --accent-rgb: 242, 193, 0;
            --card: #fcfbf8;
            --border: #1d1b19;
            --border-soft: #c8c1b7;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            --shadow-soft: 0 6px 14px rgba(0, 0, 0, 0.06);
            --border-width: 1px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Space Grotesk", sans-serif;
            color: var(--ink);
            background-color: var(--bg);
            background-image:
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 140px 140px;
            padding: 24px 18px 60px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 50%;
            left: 50%;
            width: 40vmax;
            height: 40vmax;
            transform: translate(-50%, -50%) scale(0.05);
            background: radial-gradient(
                circle,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(var(--accent-rgb), 0.9) 10%,
                rgba(var(--accent-rgb), 0) 70%
            );
            border-radius: 50%;
            animation: pulseGlow 15s infinite ease-in-out;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes pulseGlow {
            0% { transform: translate(-50%, -50%) scale(0.05); opacity: 1; }
            60% { opacity: 0.85; }
            100% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        button,
        input,
        select {
            font-family: inherit;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .page-header {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr);
            align-items: center;
            gap: 12px;
            padding: 18px 20px;
            border: var(--border-width) solid var(--border);
            background: var(--card);
            box-shadow: var(--shadow);
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
        }

        .header-right {
            justify-content: flex-end;
        }

        .site-credit {
            font-size: 0.7rem;
            letter-spacing: 0.04em;
            color: var(--muted);
        }

        h1 {
            margin: 0;
            text-align: center;
            font-size: clamp(1.6rem, 1.2rem + 1.2vw, 2.2rem);
            text-transform: uppercase;
            letter-spacing: 0.16em;
            cursor: pointer;
        }

        .toggle {
            display: inline-flex;
            border: var(--border-width) solid var(--border);
            background: #fff;
        }

        .toggle-btn {
            border: none;
            background: transparent;
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--muted);
        }

        .toggle-btn.is-active {
            background: var(--accent);
            color: var(--ink);
        }

        .filters {
            border: var(--border-width) solid var(--border);
            background: var(--card);
            padding: 18px 20px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filters-header {
            display: none;
        }

        .filters-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
        }

        .filter-grid-wide {
            grid-template-columns: minmax(0, 1fr);
        }

        .filter {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label,
        .filter-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
            font-weight: 600;
        }

        input[type="search"],
        select {
            padding: 8px 10px;
            border: var(--border-width) solid var(--border);
            background: #fff;
        }

        input[type="search"]:focus,
        select:focus {
            outline: 2px solid rgba(209, 72, 54, 0.2);
        }

        .options-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            height: 100%;
        }

        .link-btn {
            border: none;
            background: transparent;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.7rem;
            cursor: pointer;
            color: var(--accent-strong);
        }

        .view-section {
            border: var(--border-width) solid var(--border);
            background: var(--card);
            padding: 18px 20px;
            box-shadow: var(--shadow-soft);
        }

        .is-hidden {
            display: none;
        }
        .region-block {
            padding: 16px 0;
            border-top: var(--border-width) solid var(--border-soft);
        }

        .region-block:first-child {
            border-top: none;
            padding-top: 0;
        }

        .region-title {
            margin: 0 0 12px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .cinema-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .cinema-card {
            border: var(--border-width) solid var(--border);
            background: #fff;
            padding: 14px;
            text-align: left;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: var(--shadow-soft);
        }

        .cinema-card-title {
            font-weight: 600;
        }

        .cinema-card-meta {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .cinema-showtimes-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            border-bottom: var(--border-width) solid var(--border-soft);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .back-btn {
            border: var(--border-width) solid var(--border);
            background: #fff;
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        .cinema-title {
            margin: 0;
            font-size: 1.4rem;
        }

        .cinema-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cinema-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .date-block {
            padding: 14px 0;
            border-top: var(--border-width) solid var(--border-soft);
        }

        .date-block:first-child {
            border-top: none;
            padding-top: 0;
        }

        .date-title {
            margin: 0 0 12px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            font-weight: 600;
            color: var(--accent-strong);
            padding-bottom: 6px;
            border-bottom: 2px solid var(--accent);
        }

        .cinema-film {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr);
            gap: 12px;
            padding: 12px 0;
            border-top: var(--border-width) solid var(--border-soft);
        }

        .cinema-film:first-child {
            border-top: none;
            padding-top: 0;
        }

        .cinema-film-title {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-weight: 600;
        }

        .film-link {
            border: var(--border-width) solid var(--border);
            padding: 4px 8px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: #fff;
        }

        .cinema-map-link {
            margin-top: 2px;
        }

        .cinema-film-meta {
            color: var(--muted);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .time-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .time-chip {
            border: var(--border-width) solid var(--border);
            padding: 6px 10px;
            font-size: 0.8rem;
            background: #fff;
        }

        .time-chip.is-bookable {
            background: #fff;
            border-color: var(--border);
            color: var(--ink);
        }

        .film-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            border-bottom: var(--border-width) solid var(--border-soft);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .results-count {
            font-weight: 600;
        }

        .results-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .film-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .film-card {
            border: var(--border-width) solid var(--border);
            background: #fff;
            padding: 16px;
            display: grid;
            grid-template-columns: 160px minmax(0, 1fr);
            gap: 16px;
            box-shadow: var(--shadow);
        }

        .film-poster {
            width: 160px;
            aspect-ratio: 2 / 3;
            border: var(--border-width) solid var(--border-soft);
            background: #eae4da;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            color: var(--muted);
            padding: 10px;
        }

        .film-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .film-title {
            margin: 0;
            font-size: 1.3rem;
        }

        .film-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .film-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .film-blurb {
            margin: 0;
            color: var(--muted);
        }

        .tag-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            border: var(--border-width) solid var(--border-soft);
            padding: 4px 8px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .showing-row {
            display: grid;
            grid-template-columns: 160px minmax(0, 1fr);
            gap: 12px;
            align-items: flex-start;
        }

        .cinema-name {
            font-weight: 600;
        }

        .loading,
        .empty-state {
            text-align: center;
            padding: 20px;
            border: 1px dashed var(--border-soft);
            color: var(--muted);
        }

        .page-footer {
            text-align: center;
            font-size: 0.85rem;
            color: var(--muted);
            border-top: var(--border-width) solid var(--border-soft);
            padding-top: 16px;
        }

        @media (max-width: 1000px) {
            .page-header {
                grid-template-columns: minmax(0, 1fr);
                text-align: center;
            }

            .header-left,
            .header-right {
                justify-content: center;
            }

            .filter-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .filter-grid-wide {
                grid-template-columns: minmax(0, 1fr);
            }

            .cinema-showtimes-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .film-card {
                grid-template-columns: minmax(0, 1fr);
            }

            .film-poster {
                width: 100%;
                max-width: 220px;
            }

            .showing-row {
                grid-template-columns: minmax(0, 1fr);
            }

            .cinema-film {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 640px) {
            .filter-grid {
                grid-template-columns: minmax(0, 1fr);
            }

            h1 {
                letter-spacing: 0.1em;
            }

            .filters-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .filters-header-label {
                font-size: 0.85rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: var(--muted);
            }

            .filters-toggle {
                display: flex;
                align-items: center;
                gap: 6px;
                border: none;
                background: transparent;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--accent-strong);
                cursor: pointer;
                padding: 4px 0;
            }

            .filters-toggle-icon {
                transition: transform 0.2s ease;
            }

            .filters-toggle.is-collapsed .filters-toggle-icon {
                transform: rotate(-90deg);
            }

            .filters-content {
                display: none;
            }

            .filters-content.is-expanded {
                display: flex;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
            }
            body::before {
                animation: none;
                opacity: 0.25;
                transform: translate(-50%, -50%) scale(2);
            }
        }
    </style>
</head>
<body>
    <main class="page">
        <header class="page-header">
            <div class="header-left">
                <div class="site-credit">サイト制作: ネルキ・リオ (Site made by Leo Nelki)</div>
            </div>
            <div class="header-center">
                <h1>東京ミニシアター上映情報 (Tokyo Mini-Theater Showtimes)</h1>
            </div>
            <div class="header-right">
                <div class="toggle" role="group" aria-label="表示切替 (View toggles)">
                    <button class="toggle-btn is-active" data-view="cinema" type="button">シネマ別 (Cinema)</button>
                    <button class="toggle-btn" data-view="film" type="button">作品別 (Film)</button>
                </div>
            </div>
        </header>

        <section class="filters">
            <div class="filters-header">
                <span class="filters-header-label">フィルター (Filters)</span>
                <button class="filters-toggle" type="button" id="filters-toggle">
                    <span>表示 (Show)</span>
                    <span class="filters-toggle-icon">▼</span>
                </button>
            </div>
            <div class="filters-content" id="filters-content">
                <div class="filter-grid">
                    <div class="filter">
                        <label for="search-input">検索 (Search)</label>
                        <input id="search-input" type="search" placeholder="作品・劇場・監督・ジャンル (Film, cinema, director, genre)">
                    </div>
                    <div class="filter">
                        <label for="date-select">日付 (Date)</label>
                        <select id="date-select"></select>
                    </div>
                    <div class="filter">
                        <label for="time-select">時間帯 (Time)</label>
                        <select id="time-select">
                            <option value="any">指定なし (Any time)</option>
                            <option value="morning">午前 (Morning, before 12)</option>
                            <option value="afternoon">午後 (Afternoon, 12-17)</option>
                            <option value="evening">夕方 (Evening, 17-21)</option>
                            <option value="late">夜 (Late, after 21)</option>
                        </select>
                    </div>
                    <div class="filter">
                        <label for="region-select">地域 (Region)</label>
                        <select id="region-select"></select>
                    </div>
                    <div class="filter" id="sort-filter-container">
                        <label for="sort-select">並び替え (Sort)</label>
                        <select id="sort-select"></select>
                    </div>
                </div>
                <div class="filter-grid filter-grid-wide">
                    <div class="filter options-row">
                        <span class="filter-label">フィルター (Filters)</span>
                        <button class="link-btn" type="button" id="clear-filters">フィルターをクリア (Clear filters)</button>
                    </div>
                </div>
            </div>
        </section>
        <section class="view-section" id="cinema-view">
            <div id="cinema-index">
                <div class="loading">上映情報を読み込み中... (Loading showtimes...)</div>
            </div>
            <div id="cinema-showtimes" class="is-hidden">
                <div class="cinema-showtimes-header">
                    <button class="back-btn" type="button" id="back-to-cinemas">シネマ一覧へ戻る (Back to cinemas)</button>
                    <div>
                        <div class="cinema-title-row">
                            <h2 class="cinema-title" id="cinema-title"></h2>
                            <a class="film-link cinema-site-link is-hidden" id="cinema-site-link" href="#" target="_blank" rel="noopener">公式サイト (Website)</a>
                            <a class="film-link cinema-map-link" id="cinema-map-link" href="#" target="_blank" rel="noopener">地図 (Map)</a>
                        </div>
                        <div class="cinema-meta" id="cinema-meta"></div>
                    </div>
                </div>
                <div id="cinema-showtimes-list"></div>
            </div>
        </section>

        <section class="view-section is-hidden" id="film-view">
            <div class="film-view-header">
                <div class="results-count" id="film-results-count"></div>
                <div class="results-meta" id="film-results-meta"></div>
            </div>
            <div class="film-list" id="film-results-list">
                <div class="loading">上映情報を読み込み中... (Loading showtimes...)</div>
            </div>
            <div class="empty-state is-hidden" id="film-empty">該当する作品がありません (No films match those filters).</div>
        </section>

        <footer class="page-footer">
            <p>上映情報は各劇場サイトから取得しています。最終確認は公式ページでお願いします。(Listings are scraped from cinema sites. Always double-check the booking page for last-minute changes.)</p>
            <p><a href="cinema-scrapers/data/showtimes.json">上映情報JSONをダウンロード (Download the raw showtimes JSON)</a>.</p>
        </footer>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const jsonUrl = "cinema-scrapers/data/showtimes.json";
            const tmdbBase = "https://image.tmdb.org/t/p/";

            const cinemaCategories = [
                { name: "渋谷・目黒・恵比寿 (Shibuya, Meguro, Ebisu)", cinemas: [ "シアター・イメージフォーラム", "ユーロスペース", "ヒューマントラストシネマ渋谷", "Bunkamura ル・シネマ 渋谷宮下", "シネクイント", "ホワイト シネクイント", "シアターギルド代官山", "YEBISU GARDEN CINEMA", "目黒シネマ" ] },
                { name: "新宿 (Shinjuku)", cinemas: [ "新宿武蔵野館", "テアトル新宿", "シネマート新宿", "K's Cinema (ケイズシネマ)", "新宿シネマカリテ", "早稲田松竹", "アンスティチュ・フランセ東京" ] },
                { name: "都心 (Central - Ginza, Yurakucho, Kanda)", cinemas: [ "ヒューマントラストシネマ有楽町", "シネスイッチ銀座", "国立映画アーカイブ", "シネマリス", "アテネ・フランセ文化センター" ] },
                { name: "西東京 (West Tokyo - Nakano, Suginami, Setagaya)", cinemas: [ "ポレポレ東中野", "ラピュタ阿佐ヶ谷", "Morc阿佐ヶ谷", "Theater Bacchus", "アップリンク吉祥寺", "K2 Cinema", "下北沢トリウッド", "下高井戸シネマ" ] },
                { name: "北東京 (North Tokyo - Ikebukuro, Tabata)", cinemas: [ "新文芸坐", "池袋シネマ・ロサ", "CINEMA Chupki TABATA" ] },
                { name: "東東京 (East Tokyo)", cinemas: [ "Stranger (ストレンジャー)", "シネマブルースタジオ" ] },
                { name: "横浜 (Yokohama)", cinemas: [ "横浜シネマ・ジャック＆ベティ" ] }
            ];

            const cinemaRegions = {};
            cinemaCategories.forEach(function (category) {
                category.cinemas.forEach(function (cinemaName) {
                    cinemaRegions[cinemaName] = category.name;
                });
            });

            const cinemaJapaneseNames = {
                "K's Cinema (ケイズシネマ)": "ケイズシネマ",
                "Stranger (ストレンジャー)": "ストレンジャー",
                "YEBISU GARDEN CINEMA": "恵比寿ガーデンシネマ",
                "K2 Cinema": "K2シネマ",
                "Theater Bacchus": "シアターバッカス高円寺",
                "Bunkamura ル・シネマ 渋谷宮下": "Bunkamura ル・シネマ",
                "CINEMA Chupki TABATA": "チュプキ・タバタ",
                "アップリンク吉祥寺": "アップリンク吉祥寺"
            };
            const cinemaEnglishNames = {
                "K's Cinema (ケイズシネマ)": "K's Cinema",
                "Stranger (ストレンジャー)": "Stranger",
                "シネマート新宿": "Cinemart Shinjuku",
                "新宿シネマカリテ": "Shinjuku Cinema Qualite",
                "新宿武蔵野館": "Shinjuku Musashino-kan",
                "テアトル新宿": "Theatre Shinjuku",
                "早稲田松竹": "Waseda Shochiku",
                "シアターギルド代官山": "Theatre Guild Daikanyama",
                "YEBISU GARDEN CINEMA": "Yebisu Garden Cinema",
                "シアター・イメージフォーラム": "Theatre Image Forum",
                "ユーロスペース": "Eurospace",
                "ヒューマントラストシネマ渋谷": "Human Trust Cinema Shibuya",
                "新文芸坐": "Shin-Bungeiza",
                "目黒シネマ": "Meguro Cinema",
                "ポレポレ東中野": "Pole Pole Higashi-Nakano",
                "K2 Cinema": "K2 Cinema",
                "Theater Bacchus": "Theater Bacchus",
                "ヒューマントラストシネマ有楽町": "Human Trust Cinema Yurakucho",
                "ラピュタ阿佐ヶ谷": "Laputa Asagaya",
                "下高井戸シネマ": "Shimotakaido Cinema",
                "国立映画アーカイブ": "National Film Archive of Japan",
                "池袋シネマ・ロサ": "Ikebukuro Cinema Rosa",
                "シネスイッチ銀座": "Cine Switch Ginza",
                "シネマブルースタジオ" : "Cinema Blue Studio",
                "Bunkamura ル・シネマ 渋谷宮下": "Bunkamura Le Cinéma",
                "CINEMA Chupki TABATA": "Cinema Chupki Tabata",
                "シネクイント": "Cine Quinto Shibuya",
                "ホワイト シネクイント": "White Cine Quinto",
                "アップリンク吉祥寺": "Uplink Kichijoji",
                "シネマリス": "CineMalice",
                "Morc阿佐ヶ谷": "Morc Asagaya",
                "下北沢トリウッド": "Shimokitazawa Tollywood",
                "アテネ・フランセ文化センター": "Athenee Francais Cultural Center",
                "横浜シネマ・ジャック＆ベティ": "Jack and Betty Yokohama",
                "アンスティチュ・フランセ東京": "Institut Francais Tokyo"
            };


            const elements = {
                searchInput: document.getElementById("search-input"),
                dateSelect: document.getElementById("date-select"),
                timeSelect: document.getElementById("time-select"),
                regionSelect: document.getElementById("region-select"),
                sortSelect: document.getElementById("sort-select"),
                sortFilterContainer: document.getElementById("sort-filter-container"),
                clearFilters: document.getElementById("clear-filters"),
                filtersToggle: document.getElementById("filters-toggle"),
                filtersContent: document.getElementById("filters-content"),
                viewButtons: Array.from(document.querySelectorAll("[data-view]")),
                cinemaView: document.getElementById("cinema-view"),
                cinemaIndex: document.getElementById("cinema-index"),
                cinemaShowtimes: document.getElementById("cinema-showtimes"),
                cinemaTitle: document.getElementById("cinema-title"),
                cinemaMapLink: document.getElementById("cinema-map-link"),
                cinemaSiteLink: document.getElementById("cinema-site-link"),
                cinemaMeta: document.getElementById("cinema-meta"),
                cinemaShowtimesList: document.getElementById("cinema-showtimes-list"),
                backToCinemas: document.getElementById("back-to-cinemas"),
                filmView: document.getElementById("film-view"),
                filmResultsCount: document.getElementById("film-results-count"),
                filmResultsMeta: document.getElementById("film-results-meta"),
                filmResultsList: document.getElementById("film-results-list"),
                filmEmpty: document.getElementById("film-empty")
            };
            const state = {
                data: [],
                view: "cinema",
                sort: "name",
                todayDate: "",
                selectedCinema: "",
                filtersExpanded: false,
                filters: {
                    search: "",
                    date: "all",
                    time: "any",
                    region: "all"
                }
            };

            const sortOptions = {
                film: [
                    { value: "soonest", label: "最も早い (Soonest)" }
                ]
            };

            const dateFormatter = new Intl.DateTimeFormat("ja-JP", { weekday: "short", day: "numeric", month: "short" });
            const longDateFormatter = new Intl.DateTimeFormat("ja-JP", { weekday: "long", day: "numeric", month: "long" });
            const timeBucketLabels = {
                morning: "午前 (Morning, before 12)",
                afternoon: "午後 (Afternoon, 12-17)",
                evening: "夕方 (Evening, 17-21)",
                late: "夜 (Late, after 21)"
            };

            function getRegionForCinema(cinemaName) {
                return cinemaRegions[cinemaName] || "その他 (Other)";
            }

            elements.searchInput.addEventListener("input", function (event) {
                state.filters.search = event.target.value.trim().toLowerCase();
                render();
            });

            elements.dateSelect.addEventListener("change", function (event) {
                state.filters.date = event.target.value;
                render();
            });

            elements.timeSelect.addEventListener("change", function (event) {
                state.filters.time = event.target.value;
                render();
            });

            elements.regionSelect.addEventListener("change", function (event) {
                state.filters.region = event.target.value;
                render();
            });

            elements.sortSelect.addEventListener("change", function (event) {
                state.sort = event.target.value;
                render();
            });

            elements.filtersToggle.addEventListener("click", function () {
                state.filtersExpanded = !state.filtersExpanded;
                elements.filtersContent.classList.toggle("is-expanded", state.filtersExpanded);
                elements.filtersToggle.classList.toggle("is-collapsed", !state.filtersExpanded);
                elements.filtersToggle.querySelector("span:first-child").textContent = state.filtersExpanded ? "非表示 (Hide)" : "表示 (Show)";
            });

            elements.clearFilters.addEventListener("click", function () {
                state.filters.search = "";
                state.filters.date = getDefaultDateForView();
                state.filters.time = "any";
                state.filters.region = "all";

                elements.searchInput.value = "";
                elements.dateSelect.value = state.filters.date;
                elements.timeSelect.value = "any";
                elements.regionSelect.value = "all";
                render();
            });

            elements.viewButtons.forEach(function (button) {
                button.addEventListener("click", function () {
                    const view = button.getAttribute("data-view");
                    setView(view);
                });
            });

            elements.backToCinemas.addEventListener("click", function () {
                state.selectedCinema = "";
                render();
            });

            document.querySelector("h1").addEventListener("click", function () {
                state.selectedCinema = "";
                state.filters.search = "";
                elements.searchInput.value = "";
                render();
                window.scrollTo({ top: 0, behavior: "smooth" });
            });

            function setView(view) {
                state.view = view;
                elements.viewButtons.forEach(function (button) {
                    const isActive = button.getAttribute("data-view") === view;
                    button.classList.toggle("is-active", isActive);
                });
                updateSortOptions();
                if (view === "film" && state.filters.date === "all" && state.todayDate) {
                    state.filters.date = state.todayDate;
                    elements.dateSelect.value = state.todayDate;
                }
                render();
            }

            function getDefaultDateForView() {
                if (state.view === "film" && state.todayDate) {
                    return state.todayDate;
                }
                return "all";
            }

            function updateSortOptions() {
                const options = sortOptions[state.view];
                if (!options) {
                    elements.sortFilterContainer.classList.add("is-hidden");
                    return;
                }
                elements.sortFilterContainer.classList.remove("is-hidden");

                const currentValue = state.sort;
                elements.sortSelect.innerHTML = "";
                options.forEach(function (option) {
                    const optionEl = document.createElement("option");
                    optionEl.value = option.value;
                    optionEl.textContent = option.label;
                    elements.sortSelect.appendChild(optionEl);
                });
                const stillValid = options.some(function (option) {
                    return option.value === currentValue;
                });
                state.sort = stillValid ? currentValue : options[0].value;
                elements.sortSelect.value = state.sort;
            }

            function createElement(tag, className, text) {
                const element = document.createElement(tag);
                if (className) {
                    element.className = className;
                }
                if (text !== undefined) {
                    element.textContent = text;
                }
                return element;
            }

            function parseDate(dateText) {
                if (!dateText) return null;
                const date = new Date(dateText + "T00:00:00");
                if (Number.isNaN(date.getTime())) return null;
                return date;
            }

            function formatDate(dateText, longFormat) {
                const date = parseDate(dateText);
                if (!date) return dateText || "";
                return longFormat ? longDateFormatter.format(date) : dateFormatter.format(date);
            }

            function getDateRange(showings) {
                const dates = showings.map(function (showing) {
                    return showing.dateText;
                }).filter(Boolean).sort();
                if (!dates.length) return "";
                if (dates[0] === dates[dates.length - 1]) {
                    return formatDate(dates[0], true);
                }
                return formatDate(dates[0], true) + " - " + formatDate(dates[dates.length - 1], true);
            }

            function timeToMinutes(timeText) {
                if (!timeText || !timeText.includes(":")) return null;
                const parts = timeText.split(":");
                const hours = parseInt(parts[0], 10);
                const minutes = parseInt(parts[1], 10);
                if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;
                return hours * 60 + minutes;
            }

            function parseDateTime(dateText, timeText) {
                if (!dateText) return null;
                const timeValue = timeText && timeText.includes(":") ? timeText : "00:00";
                const date = new Date(dateText + "T" + timeValue + ":00");
                if (Number.isNaN(date.getTime())) return null;
                return date;
            }

            function timeValue(date) {
                return date ? date.getTime() : Number.POSITIVE_INFINITY;
            }

            function compareShowings(a, b) {
                const aTime = timeValue(a.dateTime);
                const bTime = timeValue(b.dateTime);
                if (aTime !== bTime) {
                    return aTime - bTime;
                }
                return (a.showtime || "").localeCompare(b.showtime || "");
            }

            function normalizeTitle(title) {
                return (title || "")
                    .toLowerCase()
                    .replace(/[\[\]\(\)]/g, " ")
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/^-+|-+$/g, "");
            }

            function formatBilingual(primary, secondary) {
                if (!primary && !secondary) return "";
                if (!primary) return secondary;
                if (!secondary || secondary === primary) return primary;
                return primary + " (" + secondary + ")";
            }

            function buildLetterboxdUrl(title, tmdbId) {
                if (tmdbId) {
                    return "https://letterboxd.com/tmdb/" + tmdbId + "/";
                }
                const slug = normalizeTitle(title);
                return slug ? "https://letterboxd.com/film/" + slug + "/" : "";
            }

            function getCinemaJapaneseName(cinemaName) {
                return cinemaJapaneseNames[cinemaName] || cinemaName;
            }

            function getCinemaDisplayName(cinemaName) {
                const jpName = getCinemaJapaneseName(cinemaName);
                const enName = cinemaEnglishNames[cinemaName] || "";
                return formatBilingual(jpName, enName);
            }

            function buildMapsUrl(cinemaName) {
                const query = encodeURIComponent(getCinemaJapaneseName(cinemaName) + " 東京");
                return "https://www.google.com/maps/search/?api=1&query=" + query;
            }

            const cinemaWebsiteOverrides = {
                "下北沢トリウッド": "https://tollywood.jp/",
                "下高井戸シネマ": "https://shimotakaidocinema.com/",
                "ポレポレ東中野": "https://pole2.co.jp/"
            };
            const blockedHostSuffixes = [
                "ticketsource.co.uk",
                "admit-one.co.uk",
                "eigaland.com",
                "jorudan.co.jp",
                "hellomovie.info",
                "eiga.com"
            ];
            const blockedHosts = new Set([
                "tickets.barbican.org.uk",
                "bookings.thegardencinema.co.uk"
            ]);

            function isBlockedHost(host) {
                if (blockedHosts.has(host)) return true;
                return blockedHostSuffixes.some(function (suffix) {
                    return host.endsWith(suffix);
                });
            }

            function getCinemaWebsite(cinemaName, showings) {
                if (cinemaWebsiteOverrides[cinemaName]) return cinemaWebsiteOverrides[cinemaName];
                const counts = new Map();
                const origins = new Map();

                showings.forEach(function (showing) {
                    [showing.bookingUrl, showing.detailUrl].forEach(function (url) {
                        if (!url) return;
                        let parsed;
                        try {
                            parsed = new URL(url);
                        } catch (error) {
                            return;
                        }
                        const host = parsed.hostname.toLowerCase();
                        counts.set(host, (counts.get(host) || 0) + 1);
                        if (!origins.has(host)) origins.set(host, parsed.origin);
                    });
                });

                if (!counts.size) return "";

                function pickHost(skipBlocked) {
                    let bestHost = "";
                    let bestCount = -1;
                    counts.forEach(function (count, host) {
                        if (skipBlocked && isBlockedHost(host)) return;
                        if (count > bestCount) {
                            bestHost = host;
                            bestCount = count;
                        }
                    });
                    return bestHost;
                }

                const preferredHost = pickHost(true) || pickHost(false);
                if (!preferredHost) return "";
                return origins.get(preferredHost) || ("https://" + preferredHost);
            }

            function getImageUrl(path, size) {
                if (!path) return "";
                if (path.startsWith("http")) return path;
                return tmdbBase + size + path;
            }

            function buildFilterOptions(showings) {
                const dates = Array.from(new Set(showings.map(function (showing) {
                    return showing.dateText;
                }).filter(Boolean))).sort();

                const today = new Date();
                const todayText = today.toISOString().slice(0, 10);
                state.todayDate = dates.includes(todayText) ? todayText : "";
                state.filters.date = "all";

                elements.dateSelect.innerHTML = "";
                const allOption = document.createElement("option");
                allOption.value = "all";
                allOption.textContent = "全日程 (All dates)";
                elements.dateSelect.appendChild(allOption);

                dates.forEach(function (dateText) {
                    const option = document.createElement("option");
                    option.value = dateText;
                    option.textContent = formatDate(dateText, true);
                    elements.dateSelect.appendChild(option);
                });
                if (state.view === "film" && state.todayDate) {
                    state.filters.date = state.todayDate;
                }
                elements.dateSelect.value = state.filters.date || "all";

                const regions = Array.from(new Set(showings.map(function (showing) {
                    return showing.region;
                }).filter(Boolean)));
                const orderedRegions = cinemaCategories.map(function (category) {
                    return category.name;
                }).filter(function (region) {
                    return regions.includes(region);
                });
                regions.forEach(function (region) {
                    if (!orderedRegions.includes(region)) orderedRegions.push(region);
                });
                elements.regionSelect.innerHTML = "";
                const allRegionsOption = document.createElement("option");
                allRegionsOption.value = "all";
                allRegionsOption.textContent = "全地域 (All regions)";
                elements.regionSelect.appendChild(allRegionsOption);
                orderedRegions.forEach(function (region) {
                    const option = document.createElement("option");
                    option.value = region;
                    option.textContent = region;
                    elements.regionSelect.appendChild(option);
                });
                elements.regionSelect.value = state.filters.region || "all";

                updateSortOptions();
            }

            function normalizeShowings(rawData) {
                return rawData.map(function (item, index) {
                    const titleJp = item.clean_title_jp || item.movie_title || item.movie_title_en || "Untitled";
                    const titleEn = item.movie_title_en || "";
                    const titleDisplay = formatBilingual(titleJp, titleEn);
                    const tmdbId = item.tmdb_id ? String(item.tmdb_id) : "";
                    const rawCinemaName = item.cinema_name || "不明な劇場 (Unknown cinema)";
                    const cinemaJp = getCinemaJapaneseName(rawCinemaName);
                    const region = getRegionForCinema(rawCinemaName);
                    const cinemaEn = cinemaEnglishNames[rawCinemaName] || "";
                    const cinemaDisplay = formatBilingual(cinemaJp, cinemaEn);
                    const dateText = item.date_text || "";
                    const showtime = item.showtime || "";
                    const runtimeRaw = item.runtime_min || item.runtime || "";
                    const runtime = parseInt(runtimeRaw, 10);
                    const genres = Array.isArray(item.genres) ? item.genres : [];
                    const tags = Array.isArray(item.tags) ? item.tags : [];

                    return {
                        id: index,
                        cinema: rawCinemaName,
                        region: region,
                        cinemaDisplay: cinemaDisplay,
                        cinemaJp: cinemaJp,
                        cinemaEn: cinemaEn,
                        titleJp: titleJp,
                        titleEn: titleEn,
                        titleDisplay: titleDisplay,
                        dateText: dateText,
                        showtime: showtime,
                        bookingUrl: item.booking_url || item.purchase_url || "",
                        detailUrl: item.detail_page_url || item.official_site || "",
                        director: item.director || "",
                        year: item.year || "",
                        runtime: Number.isFinite(runtime) ? runtime : "",
                        genres: genres,
                        formatTags: tags,
                        rating: item.vote_average ? Number(item.vote_average) : 0,
                        posterPath: item.tmdb_poster_path || "",
                        backdropPath: item.tmdb_backdrop_path || "",
                        overview: item.synopsis || item.tmdb_overview_jp || "",
                        tmdbId: tmdbId,
                        letterboxdUrl: buildLetterboxdUrl(item.movie_title_en || item.movie_title || titleJp, tmdbId),
                        searchText: [
                            item.movie_title,
                            item.movie_title_en,
                            item.clean_title_jp,
                            item.program_title,
                            cinemaJp,
                            cinemaEn,
                            item.director,
                            genres.join(" "),
                            tags.join(" ")
                        ].filter(Boolean).join(" ").toLowerCase(),
                        dateTime: parseDateTime(dateText, showtime),
                        timeMinutes: timeToMinutes(showtime)
                    };
                });
            }

            function applyFilters(showings) {
                return showings.filter(function (showing) {
                    if (state.filters.search && !showing.searchText.includes(state.filters.search)) {
                        return false;
                    }
                    if (state.filters.date !== "all" && showing.dateText !== state.filters.date) {
                        return false;
                    }
                    if (state.filters.time !== "any") {
                        if (showing.timeMinutes === null) return false;
                        if (state.filters.time === "morning" && showing.timeMinutes >= 12 * 60) return false;
                        if (state.filters.time === "afternoon" && (showing.timeMinutes < 12 * 60 || showing.timeMinutes >= 17 * 60)) return false;
                        if (state.filters.time === "evening" && (showing.timeMinutes < 17 * 60 || showing.timeMinutes >= 21 * 60)) return false;
                        if (state.filters.time === "late" && showing.timeMinutes < 21 * 60) return false;
                    }
                    if (state.filters.region !== "all" && showing.region !== state.filters.region) {
                        return false;
                    }
                    return true;
                });
            }

            function getFilmKey(showing) {
                const keyTitle = (showing.titleEn || showing.titleJp || showing.titleDisplay || "").trim();
                return showing.tmdbId ? "tmdb-" + showing.tmdbId : "title-" + keyTitle;
            }

            function groupByFilm(showings) {
                const map = new Map();
                showings.forEach(function (showing) {
                    const key = getFilmKey(showing);
                    if (!map.has(key)) {
                        map.set(key, {
                            key: key,
                            titleJp: showing.titleJp,
                            titleEn: showing.titleEn,
                            titleDisplay: showing.titleDisplay,
                            year: showing.year,
                            director: showing.director,
                            runtime: showing.runtime,
                            genres: showing.genres.slice(),
                            rating: showing.rating || 0,
                            overview: showing.overview,
                            posterPath: showing.posterPath,
                            formatTags: new Set(),
                            showings: [],
                            letterboxdUrl: showing.letterboxdUrl
                        });
                    }
                    const film = map.get(key);
                    film.showings.push(showing);
                    if (!film.year && showing.year) film.year = showing.year;
                    if (!film.director && showing.director) film.director = showing.director;
                    if (!film.runtime && showing.runtime) film.runtime = showing.runtime;
                    if (!film.overview && showing.overview) film.overview = showing.overview;
                    if (!film.posterPath && showing.posterPath) film.posterPath = showing.posterPath;
                    if (!film.titleEn && showing.titleEn) {
                        film.titleEn = showing.titleEn;
                        film.titleDisplay = formatBilingual(film.titleJp, film.titleEn);
                    }
                    if (showing.genres.length && !film.genres.length) film.genres = showing.genres.slice();
                    if (showing.rating > film.rating) film.rating = showing.rating;
                    if (!film.letterboxdUrl && showing.letterboxdUrl) film.letterboxdUrl = showing.letterboxdUrl;
                    showing.formatTags.forEach(function (tag) {
                        film.formatTags.add(tag);
                    });
                });

                const films = Array.from(map.values());
                films.forEach(function (film) {
                    film.showings.sort(compareShowings);
                    film.nextTime = film.showings.length ? timeValue(film.showings[0].dateTime) : Number.POSITIVE_INFINITY;
                    film.formatTags = Array.from(film.formatTags);
                });
                return films;
            }

            function getFiltersSummary() {
                const parts = [];
                if (state.filters.search) parts.push("検索: \"" + state.filters.search + "\" (Search)");
                if (state.filters.date !== "all") parts.push("日付: " + formatDate(state.filters.date, true) + " (Date)");
                if (state.filters.time !== "any") parts.push("時間帯: " + timeBucketLabels[state.filters.time]);
                if (state.filters.region !== "all") parts.push("地域: " + state.filters.region + " (Region)");
                if (!parts.length) parts.push("フィルターなし (No filters applied)");
                return parts.join(" | ");
            }
            function renderCinemaIndex(showings) {
                elements.cinemaIndex.innerHTML = "";

                const cinemasMap = new Map();
                showings.forEach(function (showing) {
                    if (!cinemasMap.has(showing.cinema)) {
                        cinemasMap.set(showing.cinema, { name: showing.cinema, showings: [] });
                    }
                    cinemasMap.get(showing.cinema).showings.push(showing);
                });

                if (!cinemasMap.size) {
                    elements.cinemaIndex.appendChild(createElement("div", "empty-state", "該当する劇場がありません (No cinemas match those filters)."));
                    return;
                }

                let renderedBlocks = 0;
                cinemaCategories.forEach(function (category) {
                    const cinemas = category.cinemas.map(function (cinemaName) {
                        const cinema = cinemasMap.get(cinemaName);
                        return cinema ? { name: cinemaName, count: cinema.showings.length } : { name: cinemaName, count: 0 };
                    }).filter(function (cinema) {
                        return cinema.count > 0;
                    });

                    if (!cinemas.length) {
                        return;
                    }
                    renderedBlocks += 1;

                    const block = createElement("div", "region-block");
                    block.appendChild(createElement("h2", "region-title", category.name));

                    const grid = createElement("div", "cinema-grid");
                    cinemas.forEach(function (cinema) {
                        const card = createElement("button", "cinema-card");
                        card.type = "button";
                        card.appendChild(createElement("div", "cinema-card-title", getCinemaDisplayName(cinema.name)));
                        card.addEventListener("click", function () {
                            state.selectedCinema = cinema.name;
                            render();
                            elements.cinemaShowtimes.scrollIntoView({ behavior: "smooth" });
                        });
                        grid.appendChild(card);
                    });

                    block.appendChild(grid);
                    elements.cinemaIndex.appendChild(block);
                });

                if (!renderedBlocks) {
                    elements.cinemaIndex.appendChild(createElement("div", "empty-state", "該当する劇場がありません (No cinemas match those filters)."));
                }
            }

            function renderCinemaShowtimes(showings) {
                elements.cinemaShowtimesList.innerHTML = "";
                elements.cinemaTitle.textContent = getCinemaDisplayName(state.selectedCinema);
                elements.cinemaMapLink.href = buildMapsUrl(state.selectedCinema);
                const allCinemaShowings = state.data.filter(function (showing) {
                    return showing.cinema === state.selectedCinema;
                });
                const cinemaWebsite = getCinemaWebsite(state.selectedCinema, allCinemaShowings.length ? allCinemaShowings : showings);
                if (cinemaWebsite) {
                    elements.cinemaSiteLink.href = cinemaWebsite;
                    elements.cinemaSiteLink.classList.remove("is-hidden");
                } else {
                    elements.cinemaSiteLink.classList.add("is-hidden");
                    elements.cinemaSiteLink.removeAttribute("href");
                }

                const range = getDateRange(showings);
                const metaParts = [];
                if (showings.length) metaParts.push(showings.length + "件の上映 (showings)");
                if (range) metaParts.push(range);
                elements.cinemaMeta.textContent = metaParts.join(" | ");

                if (!showings.length) {
                    elements.cinemaShowtimesList.appendChild(createElement("div", "empty-state", "該当する上映がありません (No showings match those filters)."));
                    return;
                }

                const byDate = new Map();
                showings.forEach(function (showing) {
                    const dateKey = showing.dateText || "日付不明 (Unknown date)";
                    if (!byDate.has(dateKey)) {
                        byDate.set(dateKey, []);
                    }
                    byDate.get(dateKey).push(showing);
                });

                Array.from(byDate.keys()).sort().forEach(function (dateKey) {
                    const group = createElement("div", "date-block");
                    group.appendChild(createElement("h3", "date-title", formatDate(dateKey, true)));

                    const filmMap = new Map();
                    byDate.get(dateKey).forEach(function (showing) {
                        const key = getFilmKey(showing);
                        if (!filmMap.has(key)) {
                            filmMap.set(key, {
                                titleDisplay: showing.titleDisplay,
                                year: showing.year,
                                director: showing.director,
                                runtime: showing.runtime,
                                letterboxdUrl: showing.letterboxdUrl,
                                showings: []
                            });
                        }
                        filmMap.get(key).showings.push(showing);
                    });

                    Array.from(filmMap.values()).forEach(function (film) {
                        film.showings.sort(compareShowings);
                        const row = createElement("div", "cinema-film");

                        const info = createElement("div");
                        const titleRow = createElement("div", "cinema-film-title");
                        titleRow.appendChild(createElement("span", null, film.titleDisplay));
                        if (film.letterboxdUrl) {
                            const letterboxd = createElement("a", "film-link", "Letterboxd");
                            letterboxd.href = film.letterboxdUrl;
                            letterboxd.target = "_blank";
                            letterboxd.rel = "noopener";
                            titleRow.appendChild(letterboxd);
                        }
                        info.appendChild(titleRow);

                        const metaParts = [];
                        if (film.year) metaParts.push(film.year);
                        if (film.director) metaParts.push(film.director);
                        if (film.runtime) metaParts.push(film.runtime + "分 (min)");
                        if (metaParts.length) {
                            info.appendChild(createElement("div", "cinema-film-meta", metaParts.join(" | ")));
                        }

                        row.appendChild(info);

                        const timeRow = createElement("div", "time-row");
                        film.showings.forEach(function (showing) {
                            const label = showing.showtime || "未定 (TBD)";
                            if (showing.bookingUrl || showing.detailUrl) {
                                const link = createElement("a", "time-chip", label);
                                link.href = showing.bookingUrl || showing.detailUrl;
                                link.target = "_blank";
                                link.rel = "noopener";
                                if (showing.bookingUrl) {
                                    link.classList.add("is-bookable");
                                }
                                timeRow.appendChild(link);
                            } else {
                                timeRow.appendChild(createElement("span", "time-chip", label));
                            }
                        });
                        row.appendChild(timeRow);
                        group.appendChild(row);
                    });

                    elements.cinemaShowtimesList.appendChild(group);
                });
            }

            function renderCinemaView(showings) {
                elements.cinemaView.classList.remove("is-hidden");
                elements.filmView.classList.add("is-hidden");

                if (state.selectedCinema) {
                    elements.cinemaIndex.classList.add("is-hidden");
                    elements.cinemaShowtimes.classList.remove("is-hidden");
                    const cinemaShowings = showings.filter(function (showing) {
                        return showing.cinema === state.selectedCinema;
                    });
                    renderCinemaShowtimes(cinemaShowings);
                } else {
                    elements.cinemaShowtimes.classList.add("is-hidden");
                    elements.cinemaIndex.classList.remove("is-hidden");
                    renderCinemaIndex(showings);
                }
            }

            function renderFilmList(films, totalShowings) {
                elements.filmResultsCount.textContent = totalShowings + "件の上映 / " + films.length + "作品 (" + totalShowings + " showings / " + films.length + " films)";
                elements.filmResultsMeta.textContent = getFiltersSummary();

                const fragment = document.createDocumentFragment();
                films.forEach(function (film) {
                    const card = createElement("article", "film-card");

                    const poster = createElement("div", "film-poster", "ポスターなし (Poster unavailable)");
                    const posterUrl = getImageUrl(film.posterPath, "w342");
                    if (posterUrl) {
                        poster.style.backgroundImage = "url(\"" + posterUrl + "\")";
                        poster.style.backgroundSize = "cover";
                        poster.style.backgroundPosition = "center";
                        poster.textContent = "";
                    }
                    card.appendChild(poster);

                    const body = createElement("div", "film-body");
                    body.appendChild(createElement("h3", "film-title", film.titleDisplay));

                    const actions = createElement("div", "film-actions");
                    if (film.letterboxdUrl) {
                        const letterboxd = createElement("a", "film-link", "Letterboxd");
                        letterboxd.href = film.letterboxdUrl;
                        letterboxd.target = "_blank";
                        letterboxd.rel = "noopener";
                        actions.appendChild(letterboxd);
                    }
                    if (actions.childNodes.length) {
                        body.appendChild(actions);
                    }

                    const metaParts = [];
                    if (film.year) metaParts.push(film.year);
                    if (film.director) metaParts.push(film.director);
                    if (film.runtime) metaParts.push(film.runtime + "分 (min)");
                    if (metaParts.length) {
                        body.appendChild(createElement("div", "film-meta", metaParts.join(" | ")));
                    }

                    if (film.overview) {
                        body.appendChild(createElement("p", "film-blurb", film.overview));
                    }

                    if (film.formatTags.length) {
                        const tagRow = createElement("div", "tag-row");
                        film.formatTags.forEach(function (tag) {
                            tagRow.appendChild(createElement("span", "tag", tag));
                        });
                        body.appendChild(tagRow);
                    }

                    const showingsByCinema = new Map();
                    film.showings.forEach(function (showing) {
                        if (!showingsByCinema.has(showing.cinema)) {
                            showingsByCinema.set(showing.cinema, []);
                        }
                        showingsByCinema.get(showing.cinema).push(showing);
                    });

                    showingsByCinema.forEach(function (showings, cinema) {
                        showings.sort(compareShowings);
                        const row = createElement("div", "showing-row");
                        row.appendChild(createElement("div", "cinema-name", getCinemaDisplayName(cinema)));

                        const timeRow = createElement("div", "time-row");
                        showings.forEach(function (showing) {
                            const includeDate = state.filters.date === "all";
                            const label = includeDate && showing.dateText
                                ? formatDate(showing.dateText, false) + " " + (showing.showtime || "未定 (TBD)")
                                : (showing.showtime || "未定 (TBD)");
                            if (showing.bookingUrl || showing.detailUrl) {
                                const link = createElement("a", "time-chip", label);
                                link.href = showing.bookingUrl || showing.detailUrl;
                                link.target = "_blank";
                                link.rel = "noopener";
                                if (showing.bookingUrl) {
                                    link.classList.add("is-bookable");
                                }
                                timeRow.appendChild(link);
                            } else {
                                timeRow.appendChild(createElement("span", "time-chip", label));
                            }
                        });
                        row.appendChild(timeRow);
                        body.appendChild(row);
                    });

                    card.appendChild(body);
                    fragment.appendChild(card);
                });

                elements.filmResultsList.appendChild(fragment);
            }

            function renderFilmView(showings) {
                elements.cinemaView.classList.add("is-hidden");
                elements.filmView.classList.remove("is-hidden");
                elements.filmResultsList.innerHTML = "";
                elements.filmEmpty.classList.add("is-hidden");
                elements.filmResultsMeta.textContent = getFiltersSummary();

                if (!showings.length) {
                    elements.filmResultsCount.textContent = "0件の上映 (0 showings)";
                    elements.filmEmpty.classList.remove("is-hidden");
                    return;
                }

                const films = groupByFilm(showings);
                if (state.sort === "soonest") {
                    films.sort(function (a, b) { return a.nextTime - b.nextTime; });
                } else {
                    films.sort(function (a, b) { return a.title.localeCompare(b.title); });
                }

                renderFilmList(films, showings.length);
            }

            function render() {
                const filtered = applyFilters(state.data);
                if (state.view === "film") {
                    renderFilmView(filtered);
                } else {
                    renderCinemaView(filtered);
                }
            }

            function fetchShowtimes() {
                fetch(jsonUrl + "?t=" + Date.now(), { cache: "no-store" })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error("HTTP error " + response.status);
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        state.data = normalizeShowings(data);
                        buildFilterOptions(state.data);
                        render();
                    })
                    .catch(function () {
                        elements.cinemaIndex.innerHTML = "";
                        elements.cinemaIndex.appendChild(createElement("div", "loading", "上映情報を読み込めません (Unable to load showtimes)."));
                        elements.filmResultsList.innerHTML = "";
                        elements.filmResultsList.appendChild(createElement("div", "loading", "上映情報を読み込めません (Unable to load showtimes)."));
                    });
            }

            fetchShowtimes();
        });
    </script>
</body>
</html>
