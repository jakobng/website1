<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokyo Mini-Theater Showtimes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f5f3ef;
            --grid: #e0d9cf;
            --ink: #1d1b19;
            --muted: #5d564f;
            --accent: #f2c100;
            --accent-strong: #c79400;
            --accent-rgb: 242, 193, 0;
            --card: #fcfbf8;
            --border: #1d1b19;
            --border-soft: #c8c1b7;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            --shadow-soft: 0 6px 14px rgba(0, 0, 0, 0.06);
            --border-width: 1px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: "Space Grotesk", sans-serif;
            color: var(--ink);
            background-color: var(--bg);
            background-image:
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 140px 140px;
            padding: 24px 18px 60px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: "";
            position: fixed;
            top: 50%;
            left: 50%;
            width: 40vmax;
            height: 40vmax;
            transform: translate(-50%, -50%) scale(0.05);
            background: radial-gradient(
                circle,
                rgba(255, 255, 255, 0.95) 0%,
                rgba(var(--accent-rgb), 0.9) 10%,
                rgba(var(--accent-rgb), 0) 70%
            );
            border-radius: 50%;
            animation: pulseGlow 15s infinite ease-in-out;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes pulseGlow {
            0% { transform: translate(-50%, -50%) scale(0.05); opacity: 1; }
            60% { opacity: 0.85; }
            100% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        button,
        input,
        select {
            font-family: inherit;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        .page-header {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) minmax(0, 1fr);
            align-items: center;
            gap: 12px;
            padding: 18px 20px;
            border: var(--border-width) solid var(--border);
            background: var(--card);
            box-shadow: var(--shadow);
        }

        .header-left,
        .header-right {
            display: flex;
            align-items: center;
        }

        .header-left {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .header-right {
            justify-content: flex-end;
        }

        .lang-toggle {
            margin-top: 4px;
        }

        .site-credit {
            font-size: 0.7rem;
            letter-spacing: 0.04em;
            color: var(--muted);
        }

        h1 {
            margin: 0;
            text-align: center;
            font-size: clamp(1.6rem, 1.2rem + 1.2vw, 2.2rem);
            text-transform: uppercase;
            letter-spacing: 0.16em;
            cursor: pointer;
        }

        .toggle {
            display: inline-flex;
            border: var(--border-width) solid var(--border);
            background: #fff;
        }

        .toggle-btn {
            border: none;
            background: transparent;
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--muted);
        }

        .toggle-btn.is-active {
            background: var(--accent);
            color: var(--ink);
        }

        .filters {
            border: var(--border-width) solid var(--border);
            background: var(--card);
            padding: 18px 20px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filters-header {
            display: none;
        }

        .filters-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 12px;
        }

        .filter-grid-wide {
            grid-template-columns: minmax(0, 1fr);
        }

        .filter {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label,
        .filter-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
            font-weight: 600;
        }

        input[type="search"],
        select {
            padding: 8px 10px;
            border: var(--border-width) solid var(--border);
            background: #fff;
        }

        input[type="search"]:focus,
        select:focus {
            outline: 2px solid rgba(209, 72, 54, 0.2);
        }

        .options-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            height: 100%;
        }

        .link-btn {
            border: none;
            background: transparent;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.7rem;
            cursor: pointer;
            color: var(--accent-strong);
        }

        .view-section {
            border: var(--border-width) solid var(--border);
            background: var(--card);
            padding: 18px 20px;
            box-shadow: var(--shadow-soft);
        }

        .is-hidden {
            display: none;
        }
        .region-block {
            padding: 16px 0;
            border-top: var(--border-width) solid var(--border-soft);
        }

        .region-block:first-child {
            border-top: none;
            padding-top: 0;
        }

        .region-title {
            margin: 0 0 12px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .cinema-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .cinema-card {
            border: var(--border-width) solid var(--border);
            background: #fff;
            padding: 14px;
            text-align: left;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: var(--shadow-soft);
        }

        .cinema-card-title {
            font-weight: 600;
        }

        .cinema-card-meta {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .cinema-showtimes-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            border-bottom: var(--border-width) solid var(--border-soft);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .back-btn {
            border: var(--border-width) solid var(--border);
            background: #fff;
            padding: 8px 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        .cinema-title {
            margin: 0;
            font-size: 1.4rem;
        }

        .cinema-title-row {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cinema-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .date-block {
            padding: 14px 0;
            border-top: var(--border-width) solid var(--border-soft);
        }

        .date-block:first-child {
            border-top: none;
            padding-top: 0;
        }

        .date-title {
            margin: 0 0 12px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            font-weight: 600;
            color: var(--accent-strong);
            padding-bottom: 6px;
            border-bottom: 2px solid var(--accent);
        }

        .cinema-film {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr);
            gap: 12px;
            padding: 12px 0;
            border-top: var(--border-width) solid var(--border-soft);
        }

        .cinema-film:first-child {
            border-top: none;
            padding-top: 0;
        }

        .cinema-film-title {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-weight: 600;
        }

        .film-link {
            border: var(--border-width) solid var(--border);
            padding: 4px 8px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: #fff;
        }

        .cinema-map-link {
            margin-top: 2px;
        }

        .cinema-film-meta {
            color: var(--muted);
            font-size: 0.8rem;
            margin-top: 4px;
        }

        .time-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .time-chip {
            border: var(--border-width) solid var(--border);
            padding: 6px 10px;
            font-size: 0.8rem;
            background: #fff;
        }

        .time-chip.is-bookable {
            background: #fff;
            border-color: var(--border);
            color: var(--ink);
        }

        .film-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            border-bottom: var(--border-width) solid var(--border-soft);
            padding-bottom: 12px;
            margin-bottom: 12px;
        }

        .results-count {
            font-weight: 600;
        }

        .results-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .film-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .film-card {
            border: var(--border-width) solid var(--border);
            background: #fff;
            padding: 16px;
            display: grid;
            grid-template-columns: 160px minmax(0, 1fr);
            gap: 16px;
            box-shadow: var(--shadow);
        }

        .film-poster {
            width: 160px;
            aspect-ratio: 2 / 3;
            border: var(--border-width) solid var(--border-soft);
            background: #eae4da;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.75rem;
            color: var(--muted);
            padding: 10px;
        }

        .film-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .film-title {
            margin: 0;
            font-size: 1.3rem;
        }

        .film-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .film-meta {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .film-blurb {
            margin: 0;
            color: var(--muted);
        }

        .tag-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag {
            border: var(--border-width) solid var(--border-soft);
            padding: 4px 8px;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .showing-row {
            display: grid;
            grid-template-columns: 160px minmax(0, 1fr);
            gap: 12px;
            align-items: flex-start;
        }

        .cinema-name {
            font-weight: 600;
        }

        .loading,
        .empty-state {
            text-align: center;
            padding: 20px;
            border: 1px dashed var(--border-soft);
            color: var(--muted);
        }

        .page-footer {
            text-align: center;
            font-size: 0.85rem;
            color: var(--muted);
            border-top: var(--border-width) solid var(--border-soft);
            padding-top: 16px;
        }

        @media (max-width: 1000px) {
            .page-header {
                grid-template-columns: minmax(0, 1fr);
                text-align: center;
            }

            .header-left,
            .header-right {
                justify-content: center;
            }

            .header-left {
                align-items: center;
            }

            .filter-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .filter-grid-wide {
                grid-template-columns: minmax(0, 1fr);
            }

            .cinema-showtimes-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .film-card {
                grid-template-columns: minmax(0, 1fr);
            }

            .film-poster {
                width: 100%;
                max-width: 220px;
            }

            .showing-row {
                grid-template-columns: minmax(0, 1fr);
            }

            .cinema-film {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 640px) {
            .filter-grid {
                grid-template-columns: minmax(0, 1fr);
            }

            h1 {
                letter-spacing: 0.1em;
            }

            .filters-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .filters-header-label {
                font-size: 0.85rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: var(--muted);
            }

            .filters-toggle {
                display: flex;
                align-items: center;
                gap: 6px;
                border: none;
                background: transparent;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--accent-strong);
                cursor: pointer;
                padding: 4px 0;
            }

            .filters-toggle-icon {
                transition: transform 0.2s ease;
            }

            .filters-toggle.is-collapsed .filters-toggle-icon {
                transform: rotate(-90deg);
            }

            .filters-content {
                display: none;
            }

            .filters-content.is-expanded {
                display: flex;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
            }
            body::before {
                animation: none;
                opacity: 0.25;
                transform: translate(-50%, -50%) scale(2);
            }
        }

        /* Region Map Styles */
        .region-map-section {
            background: var(--card);
            border: var(--border-width) solid var(--border);
            box-shadow: var(--shadow-soft);
        }

        .region-map-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--ink);
        }

        .region-map-summary-toggle {
            font-size: 0.8rem;
            color: var(--muted);
            font-weight: 500;
            border: var(--border-width) solid var(--border);
            background: transparent;
            padding: 4px 10px;
            cursor: pointer;
        }

        .region-map-section.is-collapsed .region-map-content {
            display: none;
        }

        .region-map-section.is-collapsed .region-map-summary {
            border-bottom: none;
        }

        .region-map-section .region-map-summary {
        }

        .region-map-section[open] .region-map-summary {
            border-bottom: var(--border-width) solid var(--border);
        }

        .region-map-content {
            padding: 12px 16px 16px;
        }

        #region-map {
            width: 100%;
            max-width: 320px;
            max-width: 360px;
            height: auto;
            margin: 0 auto;
            display: block;
        }

        .region-area {
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .region-area:hover {
            transform: scale(1.02);
        }

        .region-shape {
            fill: var(--bg);
            stroke: var(--border);
            stroke-width: 1.5;
            transition: fill 0.2s ease, stroke 0.2s ease;
        }

        .region-area:hover .region-shape {
            fill: rgba(var(--accent-rgb), 0.2);
            stroke: var(--accent-strong);
            stroke-width: 2;
        }

        .region-area.is-selected .region-shape {
            fill: rgba(var(--accent-rgb), 0.35);
            stroke: var(--accent-strong);
            stroke-width: 2.5;
        }

        .region-label-ja {
            font-size: 11px;
            font-weight: 600;
            fill: var(--ink);
            text-anchor: middle;
            pointer-events: none;
        }

        .region-label-en {
            font-size: 8px;
            fill: var(--muted);
            text-anchor: middle;
            pointer-events: none;
        }

        .region-count {
            font-size: 8px;
            fill: var(--muted);
            text-anchor: middle;
            pointer-events: none;
        }

        .bay-label {
            font-size: 11px;
            fill: #7ba3b8;
            font-weight: 500;
            text-anchor: middle;
            pointer-events: none;
        }

        .bay-label-en {
            font-size: 9px;
            fill: #7ba3b8;
            text-anchor: middle;
            pointer-events: none;
            opacity: 0.7;
        }

        .map-legend {
            display: flex;
            justify-content: center;
            margin-top: 12px;
        }

        .map-reset-btn {
            background: transparent;
            border: var(--border-width) solid var(--border);
            padding: 6px 14px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .map-reset-btn:hover {
            background: var(--bg);
        }

        .map-reset-btn.is-hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .region-map-summary {
                padding: 10px 12px;
            }

            .region-map-content {
                padding: 10px 12px 12px;
            }

            .region-label-ja {
                font-size: 10px;
            }

            .region-label-en {
                font-size: 7px;
            }
        }
    </style>
</head>
<body>
    <main class="page">
        <header class="page-header">
            <div class="header-left">
                <div class="site-credit" id="site-credit"></div>
                <div class="toggle lang-toggle" role="group" aria-label="Language">
                    <button class="toggle-btn" data-lang="ja" type="button">日本語</button>
                    <button class="toggle-btn" data-lang="en" type="button">EN</button>
                </div>
            </div>
            <div class="header-center">
                <h1 id="site-title"></h1>
            </div>
            <div class="header-right">
                <div class="toggle" role="group" aria-label="View toggles">
                    <button class="toggle-btn is-active" data-view="cinema" type="button" id="view-cinema-btn"></button>
                    <button class="toggle-btn" data-view="film" type="button" id="view-film-btn"></button>
                </div>
            </div>
        </header>

        <section class="filters">
            <div class="filters-header">
                <span class="filters-header-label" id="filters-label"></span>
                <button class="filters-toggle" type="button" id="filters-toggle">
                    <span id="filters-toggle-text"></span>
                    <span class="filters-toggle-icon">▼</span>
                </button>
            </div>
            <div class="filters-content" id="filters-content">
                <div class="filter-grid">
                    <div class="filter">
                        <label for="search-input" id="search-label"></label>
                        <input id="search-input" type="search">
                    </div>
                    <div class="filter">
                        <label for="date-select" id="date-label"></label>
                        <select id="date-select"></select>
                    </div>
                    <div class="filter">
                        <label for="time-select" id="time-label"></label>
                        <select id="time-select"></select>
                    </div>
                    <div class="filter">
                        <label for="region-select" id="region-label"></label>
                        <select id="region-select"></select>
                    </div>
                    <div class="filter" id="sort-filter-container">
                        <label for="sort-select" id="sort-label"></label>
                        <select id="sort-select"></select>
                    </div>
                    <div class="filter">
                        <label for="doc-only" id="doc-only-label"></label>
                        <input id="doc-only" type="checkbox">
                    </div>
                </div>
                <div class="filter-grid filter-grid-wide">
                    <div class="filter options-row">
                        <span class="filter-label" id="filter-options-label"></span>
                        <button class="link-btn" type="button" id="clear-filters"></button>
                    </div>
                </div>
            </div>
        </section>

        <section class="region-map-section is-collapsed" id="region-map-section">
            <div class="region-map-summary">
                <span class="region-map-summary-title" id="map-summary-title"></span>
                <button class="region-map-summary-toggle" type="button" id="map-toggle-btn"></button>
            </div>
            <div class="region-map-content" id="region-map-content">
                <svg id="region-map" viewBox="0 0 400 340" xmlns="http://www.w3.org/2000/svg">
                    <!-- Tokyo Bay water -->
                    <path d="M 250 40 L 400 40 L 400 340 L 190 340 L 205 270 L 280 230 L 305 160 L 300 80 L 250 45 Z"
                          fill="#e8f4f8" stroke="none"/>

                    <!-- Bay label -->
                    <text x="336" y="205" class="bay-label">東京湾</text>
                    <text x="336" y="221" class="bay-label-en">Tokyo Bay</text>

                    <!-- Coastline -->
                    <path d="M 250 45 L 300 80 L 305 160 L 280 230 L 205 270"
                          fill="none" stroke="var(--border-soft)" stroke-width="2"/>

                    <!-- Region: Ikebukuro (Toshima-ku area - north) -->
                    <g class="region-area" data-region="池袋 (Ikebukuro)">
                        <path d="M 110 55 L 170 45 L 210 60 L 205 95 L 150 100 L 110 80 Z" class="region-shape"/>
                        <text x="160" y="68" class="region-label-ja">池袋</text>
                        <text x="160" y="82" class="region-label-en">Ikebukuro</text>
                        <text x="160" y="94" class="region-count"></text>
                    </g>

                    <!-- Region: Tabata & Kita Senju (north-east cluster) -->
                    <g class="region-area" data-region="田端・北千住 (Tabata & Kita Senju)">
                        <path d="M 210 60 L 250 50 L 285 70 L 275 100 L 235 105 L 205 95 Z" class="region-shape"/>
                        <text x="246" y="74" class="region-label-ja">田端・北千住</text>
                        <text x="246" y="88" class="region-label-en">Tabata & Kita Senju</text>
                        <text x="246" y="100" class="region-count"></text>
                    </g>

                    <!-- Region: Shinjuku/Waseda (west-central) -->
                    <g class="region-area" data-region="新宿・早稲田 (Shinjuku & Waseda)">
                        <path d="M 70 90 L 110 55 L 110 80 L 150 100 L 145 140 L 100 150 L 70 120 Z" class="region-shape"/>
                        <text x="118" y="108" class="region-label-ja">新宿</text>
                        <text x="118" y="122" class="region-label-en">Shinjuku</text>
                        <text x="118" y="134" class="region-count"></text>
                    </g>

                    <!-- Region: Central & East (Ginza, Jimbocho, Sumida) -->
                    <g class="region-area" data-region="都心・東部 (Central & East - Ginza to Sumida)">
                        <path d="M 150 100 L 205 95 L 235 105 L 275 100 L 300 130 L 295 170 L 260 205 L 200 200 L 145 140 Z" class="region-shape"/>
                        <text x="226" y="140" class="region-label-ja">都心・東部</text>
                        <text x="226" y="154" class="region-label-en">Central & East</text>
                        <text x="226" y="166" class="region-count"></text>
                    </g>

                    <!-- Region: Shibuya/Ebisu/Meguro (southwest wards) -->
                    <g class="region-area" data-region="渋谷・恵比寿・目黒 (Shibuya, Ebisu & Meguro)">
                        <path d="M 70 120 L 100 150 L 145 140 L 200 200 L 260 205 L 250 235 L 200 260 L 120 250 L 80 210 Z" class="region-shape"/>
                        <text x="168" y="210" class="region-label-ja">渋谷・恵比寿・目黒</text>
                        <text x="168" y="224" class="region-label-en">Shibuya Area</text>
                        <text x="168" y="236" class="region-count"></text>
                    </g>

                    <!-- Region: West (Nakano, Suginami, Setagaya, Tachikawa, Ome - western suburbs) -->
                    <g class="region-area" data-region="西部 (West - Chuo/Keio Lines & Setagaya)">
                        <path d="M 20 70 L 70 90 L 70 120 L 80 210 L 60 240 L 20 220 Z" class="region-shape"/>
                        <text x="46" y="150" class="region-label-ja">西部</text>
                        <text x="46" y="164" class="region-label-en">West</text>
                        <text x="46" y="176" class="region-count"></text>
                    </g>

                    <!-- Region: Yokohama (Kanagawa - separate city to southwest) -->
                    <g class="region-area" data-region="横浜 (Yokohama)">
                        <path d="M 60 240 L 120 250 L 200 260 L 210 340 L 60 340 Z" class="region-shape"/>
                        <text x="140" y="300" class="region-label-ja">横浜</text>
                        <text x="140" y="314" class="region-label-en">Yokohama</text>
                        <text x="140" y="326" class="region-count"></text>
                    </g>
                </svg>
                <div class="map-legend">
                    <button class="map-reset-btn" type="button" id="map-reset-btn"></button>
                </div>
            </div>
        </section>

        <section class="view-section" id="cinema-view">
            <div id="cinema-index">
                <div class="loading" id="cinema-loading"></div>
            </div>
            <div id="cinema-showtimes" class="is-hidden">
                <div class="cinema-showtimes-header">
                    <button class="back-btn" type="button" id="back-to-cinemas"></button>
                    <div>
                        <div class="cinema-title-row">
                            <h2 class="cinema-title" id="cinema-title"></h2>
                            <a class="film-link cinema-site-link is-hidden" id="cinema-site-link" href="#" target="_blank" rel="noopener"></a>
                            <a class="film-link cinema-map-link" id="cinema-map-link" href="#" target="_blank" rel="noopener"></a>
                        </div>
                        <div class="cinema-meta" id="cinema-meta"></div>
                    </div>
                </div>
                <div id="cinema-showtimes-list"></div>
            </div>
        </section>

        <section class="view-section is-hidden" id="film-view">
            <div class="film-view-header">
                <div class="results-count" id="film-results-count"></div>
                <div class="results-meta" id="film-results-meta"></div>
            </div>
            <div class="film-list" id="film-results-list">
                <div class="loading" id="film-loading"></div>
            </div>
            <div class="empty-state is-hidden" id="film-empty"></div>
        </section>

        <footer class="page-footer">
            <p id="footer-disclaimer"></p>
            <p><a href="cinema-scrapers/data/showtimes.json" id="footer-download-link"></a></p>
        </footer>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const jsonUrl = "cinema-scrapers/data/showtimes.json";
            const tmdbBase = "https://image.tmdb.org/t/p/";

            const cinemaCategories = [
                { name: "渋谷・恵比寿・目黒 (Shibuya, Ebisu & Meguro)", cinemas: [ "シアター・イメージフォーラム", "ユーロスペース", "ヒューマントラストシネマ渋谷", "Bunkamura ル・シネマ 渋谷宮下", "シネクイント", "ホワイト シネクイント", "シネマヴェーラ渋谷", "YEBISU GARDEN CINEMA", "目黒シネマ" ] },
                { name: "新宿・早稲田 (Shinjuku & Waseda)", cinemas: [ "新宿武蔵野館", "テアトル新宿", "シネマート新宿", "K's Cinema (ケイズシネマ)", "kino cinéma新宿", "シネマリス", "早稲田松竹" ] },
                { name: "都心・東部 (Central & East - Ginza to Sumida)", cinemas: [ "ヒューマントラストシネマ有楽町", "シネスイッチ銀座", "国立映画アーカイブ", "Kadokawa Cinema Yurakucho (角川シネマ有楽町)", "神保町シアター", "アテネ・フランセ文化センター", "アンスティチュ・フランセ東京", "Stranger (ストレンジャー)" ] },
                { name: "池袋 (Ikebukuro)", cinemas: [ "新文芸坐", "池袋シネマ・ロサ" ] },
                { name: "田端・北千住 (Tabata & Kita Senju)", cinemas: [ "CINEMA Chupki TABATA", "シネマブルースタジオ" ] },
                { name: "西部 (West - Chuo/Keio Lines & Setagaya)", cinemas: [ "ポレポレ東中野", "ラピュタ阿佐ヶ谷", "Morc阿佐ヶ谷", "アップリンク吉祥寺", "K2 Cinema", "下北沢トリウッド", "下高井戸シネマ", "kino cinéma立川髙島屋S.C.館", "Cinema Neko (シネマネコ)" ] },
                { name: "横浜 (Yokohama)", cinemas: [ "横浜シネマ・ジャック＆ベティ", "シネマ・ノヴェチェント", "横浜シネマリン" ] }
            ];

            const cinemaRegions = {};
            cinemaCategories.forEach(function (category) {
                category.cinemas.forEach(function (cinemaName) {
                    cinemaRegions[cinemaName] = category.name;
                });
            });

            const cinemaJapaneseNames = {
                "K's Cinema (ケイズシネマ)": "ケイズシネマ",
                "Stranger (ストレンジャー)": "ストレンジャー",
                "K2 Cinema": "K2シネマ",
                "Bunkamura ル・シネマ 渋谷宮下": "Bunkamura ル・シネマ",
                "CINEMA Chupki TABATA": "チュプキ・タバタ",
                "Cinema Neko (シネマネコ)": "シネマネコ",
                "YEBISU GARDEN CINEMA": "恵比寿ガーデンシネマ",
                "Kadokawa Cinema Yurakucho (角川シネマ有楽町)": "角川シネマ有楽町"
            };
            const cinemaEnglishNames = {
                "K's Cinema (ケイズシネマ)": "K's Cinema",
                "Stranger (ストレンジャー)": "Stranger",
                "シネマート新宿": "Cinemart Shinjuku",
                "新宿武蔵野館": "Shinjuku Musashino-kan",
                "テアトル新宿": "Theatre Shinjuku",
                "早稲田松竹": "Waseda Shochiku",
                "シアター・イメージフォーラム": "Theatre Image Forum",
                "ユーロスペース": "Eurospace",
                "ヒューマントラストシネマ渋谷": "Human Trust Cinema Shibuya",
                "シネマヴェーラ渋谷": "Cinema Vera Shibuya",
                "新文芸坐": "Shin-Bungeiza",
                "目黒シネマ": "Meguro Cinema",
                "ポレポレ東中野": "Pole Pole Higashi-Nakano",
                "K2 Cinema": "K2 Cinema",
                "ヒューマントラストシネマ有楽町": "Human Trust Cinema Yurakucho",
                "ラピュタ阿佐ヶ谷": "Laputa Asagaya",
                "下高井戸シネマ": "Shimotakaido Cinema",
                "国立映画アーカイブ": "National Film Archive of Japan",
                "神保町シアター": "Jimbocho Theatre",
                "池袋シネマ・ロサ": "Ikebukuro Cinema Rosa",
                "シネスイッチ銀座": "Cine Switch Ginza",
                "シネマブルースタジオ": "Cinema Blue Studio",
                "Bunkamura ル・シネマ 渋谷宮下": "Bunkamura Le Cinéma",
                "CINEMA Chupki TABATA": "Cinema Chupki Tabata",
                "シネクイント": "Cine Quinto Shibuya",
                "ホワイト シネクイント": "White Cine Quinto",
                "アップリンク吉祥寺": "Uplink Kichijoji",
                "シネマリス": "CineMalice",
                "Morc阿佐ヶ谷": "Morc Asagaya",
                "下北沢トリウッド": "Shimokitazawa Tollywood",
                "アテネ・フランセ文化センター": "Athenee Francais Cultural Center",
                "横浜シネマ・ジャック＆ベティ": "Jack and Betty Yokohama",
                "アンスティチュ・フランセ東京": "Institut Francais Tokyo",
                "シネマ・ノヴェチェント": "Cinema Novecento",
                "kino cinéma新宿": "Kino Cinema Shinjuku",
                "kino cinéma立川髙島屋S.C.館": "Kino Cinema Tachikawa",
                "横浜シネマリン": "Yokohama Cinemarine",
                "Cinema Neko (シネマネコ)": "Cinema Neko",
                "YEBISU GARDEN CINEMA": "Yebisu Garden Cinema",
                "Kadokawa Cinema Yurakucho (角川シネマ有楽町)": "Kadokawa Cinema Yurakucho"
            };

            const regionNames = {
                "渋谷・恵比寿・目黒 (Shibuya, Ebisu & Meguro)": { ja: "渋谷・恵比寿・目黒", en: "Shibuya, Ebisu & Meguro" },
                "新宿・早稲田 (Shinjuku & Waseda)": { ja: "新宿・早稲田", en: "Shinjuku & Waseda" },
                "都心・東部 (Central & East - Ginza to Sumida)": { ja: "都心・東部（銀座〜墨田）", en: "Central & East (Ginza to Sumida)" },
                "池袋 (Ikebukuro)": { ja: "池袋", en: "Ikebukuro" },
                "田端・北千住 (Tabata & Kita Senju)": { ja: "田端・北千住", en: "Tabata & Kita Senju" },
                "西部 (West - Chuo/Keio Lines & Setagaya)": { ja: "西部（中央線・京王線沿線、世田谷）", en: "West (Chuo/Keio Lines & Setagaya)" },
                "横浜 (Yokohama)": { ja: "横浜", en: "Yokohama" }
            };

            const i18n = {
                ja: {
                    siteTitle: "東京ミニシアター上映情報",
                    siteCredit: "サイト制作: ネルキ・リオ",
                    viewCinema: "シネマ別",
                    viewFilm: "作品別",
                    filters: "フィルター",
                    filtersShow: "表示",
                    filtersHide: "非表示",
                    search: "検索",
                    searchPlaceholder: "作品・劇場・監督・ジャンル",
                    date: "日付",
                    dateAll: "すべての日付",
                    time: "時間帯",
                    timeAny: "指定なし",
                    timeMorning: "午前（12時前）",
                    timeAfternoon: "午後（12〜17時）",
                    timeEvening: "夕方（17〜21時）",
                    timeLate: "夜（21時以降）",
                    region: "地域",
                    regionAll: "すべての地域",
                    sort: "並び替え",
                    sortSoonest: "最も早い",
                    sortReleaseNew: "公開年（新しい順）",
                    sortReleaseOld: "公開年（古い順）",
                    sortRating: "評価順",
                    docOnly: "ドキュメンタリーのみ",
                    clearFilters: "フィルターをクリア",
                    loading: "上映情報を読み込み中...",
                    loadError: "上映情報を読み込めません",
                    noFilms: "該当する作品がありません",
                    noCinemas: "該当するシネマがありません",
                    noShowings: "該当する上映がありません",
                    backToCinemas: "シネマ一覧へ戻る",
                    films: "作品",
                    showings: "上映",
                    cinemas: "シネマ",
                    map: "地図",
                    site: "公式サイト",
                    today: "今日",
                    tomorrow: "明日",
                    min: "分",
                    posterUnavailable: "ポスターなし",
                    tbd: "未定",
                    other: "その他",
                    unknownCinema: "不明な劇場",
                    untitled: "タイトル未定",
                    footerDisclaimer: "上映情報は各劇場サイトから取得しています。最終確認は公式ページでお願いします。",
                    downloadJson: "上映情報JSONをダウンロード",
                    mapReset: "すべての地域を表示",
                    mapShow: "地図を表示",
                    mapHide: "地図を隠す",
                    mapCinemaCount: "館"
                },
                en: {
                    siteTitle: "Tokyo Mini-Theater Showtimes",
                    siteCredit: "Site by Leo Nelki",
                    viewCinema: "By Cinema",
                    viewFilm: "By Film",
                    filters: "Filters",
                    filtersShow: "Show",
                    filtersHide: "Hide",
                    search: "Search",
                    searchPlaceholder: "Film, cinema, director, genre",
                    date: "Date",
                    dateAll: "All dates",
                    time: "Time",
                    timeAny: "Any time",
                    timeMorning: "Morning (before 12)",
                    timeAfternoon: "Afternoon (12-17)",
                    timeEvening: "Evening (17-21)",
                    timeLate: "Late (after 21)",
                    region: "Region",
                    regionAll: "All regions",
                    sort: "Sort",
                    sortSoonest: "Soonest",
                    sortReleaseNew: "Release year (newest)",
                    sortReleaseOld: "Release year (oldest)",
                    sortRating: "By rating",
                    docOnly: "Documentary only",
                    clearFilters: "Clear filters",
                    loading: "Loading showtimes...",
                    loadError: "Unable to load showtimes",
                    noFilms: "No films match those filters",
                    noCinemas: "No cinemas match those filters",
                    noShowings: "No showings match those filters",
                    backToCinemas: "Back to cinemas",
                    films: "films",
                    showings: "showings",
                    cinemas: "cinemas",
                    map: "Map",
                    site: "Website",
                    today: "Today",
                    tomorrow: "Tomorrow",
                    min: "min",
                    posterUnavailable: "No poster",
                    tbd: "TBD",
                    other: "Other",
                    unknownCinema: "Unknown cinema",
                    untitled: "Untitled",
                    footerDisclaimer: "Listings are scraped from cinema sites. Always double-check the booking page for last-minute changes.",
                    downloadJson: "Download raw showtimes JSON",
                    mapReset: "Show all regions",
                    mapShow: "Show map",
                    mapHide: "Hide map",
                    mapCinemaCount: "cinemas"
                }
            };

            function t(key) {
                return i18n[state.lang][key] || i18n.ja[key] || key;
            }

            function getRegionName(fullName) {
                const names = regionNames[fullName];
                if (names) return names[state.lang];
                return fullName;
            }

            function getCinemaDisplayName(cinemaName) {
                if (state.lang === "en") {
                    return cinemaEnglishNames[cinemaName] || cinemaName;
                } else {
                    return cinemaJapaneseNames[cinemaName] || cinemaName;
                }
            }

            function getFilmDisplayTitle(film) {
                if (state.lang === "en") {
                    return film.titleEn || film.titleJp || film.titleDisplay;
                } else {
                    return film.titleJp || film.titleDisplay;
                }
            }

            function getFilmDirector(film) {
                if (state.lang === "en") {
                    return film.directorEn || film.director || "";
                } else {
                    return film.director || "";
                }
            }

            const elements = {
                // Header
                siteTitle: document.getElementById("site-title"),
                siteCredit: document.getElementById("site-credit"),
                viewCinemaBtn: document.getElementById("view-cinema-btn"),
                viewFilmBtn: document.getElementById("view-film-btn"),
                // Filters
                filtersLabel: document.getElementById("filters-label"),
                filtersToggle: document.getElementById("filters-toggle"),
                filtersToggleText: document.getElementById("filters-toggle-text"),
                filtersContent: document.getElementById("filters-content"),
                searchLabel: document.getElementById("search-label"),
                searchInput: document.getElementById("search-input"),
                dateLabel: document.getElementById("date-label"),
                dateSelect: document.getElementById("date-select"),
                timeLabel: document.getElementById("time-label"),
                timeSelect: document.getElementById("time-select"),
                regionLabel: document.getElementById("region-label"),
                regionSelect: document.getElementById("region-select"),
                sortLabel: document.getElementById("sort-label"),
                sortSelect: document.getElementById("sort-select"),
                sortFilterContainer: document.getElementById("sort-filter-container"),
                docOnlyLabel: document.getElementById("doc-only-label"),
                docOnlyCheckbox: document.getElementById("doc-only"),
                filterOptionsLabel: document.getElementById("filter-options-label"),
                clearFilters: document.getElementById("clear-filters"),
                // View toggles
                viewButtons: Array.from(document.querySelectorAll("[data-view]")),
                langButtons: Array.from(document.querySelectorAll("[data-lang]")),
                // Cinema view
                cinemaView: document.getElementById("cinema-view"),
                cinemaIndex: document.getElementById("cinema-index"),
                cinemaLoading: document.getElementById("cinema-loading"),
                cinemaShowtimes: document.getElementById("cinema-showtimes"),
                cinemaTitle: document.getElementById("cinema-title"),
                cinemaMapLink: document.getElementById("cinema-map-link"),
                cinemaSiteLink: document.getElementById("cinema-site-link"),
                cinemaMeta: document.getElementById("cinema-meta"),
                cinemaShowtimesList: document.getElementById("cinema-showtimes-list"),
                backToCinemas: document.getElementById("back-to-cinemas"),
                // Film view
                filmView: document.getElementById("film-view"),
                filmResultsCount: document.getElementById("film-results-count"),
                filmResultsMeta: document.getElementById("film-results-meta"),
                filmResultsList: document.getElementById("film-results-list"),
                filmLoading: document.getElementById("film-loading"),
                filmEmpty: document.getElementById("film-empty"),
                // Footer
                footerDisclaimer: document.getElementById("footer-disclaimer"),
                footerDownloadLink: document.getElementById("footer-download-link"),
                // Region Map
                mapSummaryTitle: document.getElementById("map-summary-title"),
                mapToggleBtn: document.getElementById("map-toggle-btn"),
                mapSummaryToggle: document.getElementById("map-summary-toggle"),
                regionMap: document.getElementById("region-map"),
                regionMapSection: document.getElementById("region-map-section"),
                regionMapContent: document.getElementById("region-map-content"),
                regionAreas: Array.from(document.querySelectorAll(".region-area")),
                mapResetBtn: document.getElementById("map-reset-btn")
            };
            const state = {
                data: [],
                view: "cinema",
                sort: "soonest",
                todayDate: "",
                selectedCinema: "",
                filtersExpanded: false,
                lang: localStorage.getItem("cinemas-lang") || "ja",
                filters: {
                    search: "",
                    date: "all",
                    time: "any",
                    region: "all",
                    docOnly: false
                }
            };

            function getSortOptions() {
                return {
                    film: [
                        { value: "soonest", label: t("sortSoonest") },
                        { value: "release-new", label: t("sortReleaseNew") },
                        { value: "release-old", label: t("sortReleaseOld") }
                    ]
                };
            }

            function getDateFormatter() {
                const locale = state.lang === "en" ? "en-US" : "ja-JP";
                return new Intl.DateTimeFormat(locale, { weekday: "short", day: "numeric", month: "short", timeZone: "Asia/Tokyo" });
            }

            function getLongDateFormatter() {
                const locale = state.lang === "en" ? "en-US" : "ja-JP";
                return new Intl.DateTimeFormat(locale, { weekday: "long", day: "numeric", month: "long", timeZone: "Asia/Tokyo" });
            }

            function getRegionForCinema(cinemaName) {
                return cinemaRegions[cinemaName] || t("other");
            }

            elements.searchInput.addEventListener("input", function (event) {
                state.filters.search = event.target.value.trim().toLowerCase();
                render();
            });

            elements.dateSelect.addEventListener("change", function (event) {
                state.filters.date = event.target.value;
                render();
            });

            elements.timeSelect.addEventListener("change", function (event) {
                state.filters.time = event.target.value;
                render();
            });

            elements.regionSelect.addEventListener("change", function (event) {
                state.filters.region = event.target.value;
                render();
            });

            elements.docOnlyCheckbox.addEventListener("change", function (event) {
                state.filters.docOnly = event.target.checked;
                render();
            });

            elements.sortSelect.addEventListener("change", function (event) {
                state.sort = event.target.value;
                render();
            });

            elements.filtersToggle.addEventListener("click", function () {
                state.filtersExpanded = !state.filtersExpanded;
                elements.filtersContent.classList.toggle("is-expanded", state.filtersExpanded);
                elements.filtersToggle.classList.toggle("is-collapsed", !state.filtersExpanded);
                elements.filtersToggle.querySelector("span:first-child").textContent = state.filtersExpanded ? "非表示 (Hide)" : "表示 (Show)";
            });

            elements.clearFilters.addEventListener("click", function () {
                state.filters.search = "";
                state.filters.date = getDefaultDateForView();
                state.filters.time = "any";
                state.filters.region = "all";
                state.filters.docOnly = false;

                elements.searchInput.value = "";
                elements.dateSelect.value = state.filters.date;
                elements.timeSelect.value = "any";
                elements.regionSelect.value = "all";
                elements.docOnlyCheckbox.checked = false;
                render();
            });

            // Region map event listeners
            elements.regionAreas.forEach(function (area) {
                area.addEventListener("click", function () {
                    const region = area.getAttribute("data-region");
                    if (state.filters.region === region) {
                        // Clicking selected region deselects it
                        state.filters.region = "all";
                    } else {
                        state.filters.region = region;
                    }
                    elements.regionSelect.value = state.filters.region;
                    render();
                });
            });

            elements.mapResetBtn.addEventListener("click", function () {
                state.filters.region = "all";
                elements.regionSelect.value = "all";
                render();
            });

            elements.mapToggleBtn.addEventListener("click", function () {
                elements.regionMapSection.classList.toggle("is-collapsed");
            });
            elements.regionMapSection.addEventListener("toggle", function () {
                updateMapSummaryText();
            });

            elements.viewButtons.forEach(function (button) {
                button.addEventListener("click", function () {
                    const view = button.getAttribute("data-view");
                    setView(view);
                });
            });

            elements.langButtons.forEach(function (button) {
                button.addEventListener("click", function () {
                    const lang = button.getAttribute("data-lang");
                    setLang(lang);
                });
            });

            elements.backToCinemas.addEventListener("click", function () {
                state.selectedCinema = "";
                render();
            });

            document.querySelector("h1").addEventListener("click", function () {
                state.selectedCinema = "";
                state.filters.search = "";
                elements.searchInput.value = "";
                render();
                window.scrollTo({ top: 0, behavior: "smooth" });
            });

            function setView(view) {
                state.view = view;
                elements.viewButtons.forEach(function (button) {
                    const isActive = button.getAttribute("data-view") === view;
                    button.classList.toggle("is-active", isActive);
                });
                updateSortOptions();
                if (view === "film" && state.filters.date === "all" && state.todayDate) {
                    state.filters.date = state.todayDate;
                    elements.dateSelect.value = state.todayDate;
                }
                render();
            }

            function setLang(lang) {
                state.lang = lang;
                localStorage.setItem("cinemas-lang", lang);
                elements.langButtons.forEach(function (button) {
                    const isActive = button.getAttribute("data-lang") === lang;
                    button.classList.toggle("is-active", isActive);
                });
                updateUIText();
                updateTimeSelect();
                updateDateSelect();
                updateRegionSelect();
                updateSortOptions();
                render();
            }

            function updateUIText() {
                // Header
                elements.siteTitle.textContent = t("siteTitle");
                elements.siteCredit.textContent = t("siteCredit");
                elements.viewCinemaBtn.textContent = t("viewCinema");
                elements.viewFilmBtn.textContent = t("viewFilm");

                // Filters
                elements.filtersLabel.textContent = t("filters");
                elements.filtersToggleText.textContent = state.filtersExpanded ? t("filtersHide") : t("filtersShow");
                elements.searchLabel.textContent = t("search");
                elements.searchInput.placeholder = t("searchPlaceholder");
                elements.dateLabel.textContent = t("date");
                elements.timeLabel.textContent = t("time");
                elements.regionLabel.textContent = t("region");
                elements.sortLabel.textContent = t("sort");
                elements.docOnlyLabel.textContent = t("docOnly");
                elements.filterOptionsLabel.textContent = t("filters");
                elements.clearFilters.textContent = t("clearFilters");
                elements.docOnlyCheckbox.checked = state.filters.docOnly;

                // Cinema view
                elements.cinemaLoading.textContent = t("loading");
                elements.backToCinemas.textContent = t("backToCinemas");
                elements.cinemaMapLink.textContent = t("map");
                elements.cinemaSiteLink.textContent = t("site");

                // Film view
                elements.filmLoading.textContent = t("loading");
                elements.filmEmpty.textContent = t("noFilms");

                // Footer
                elements.footerDisclaimer.textContent = t("footerDisclaimer");
                elements.footerDownloadLink.textContent = t("downloadJson");

                // Map summary
                updateMapSummaryText();
            }

            function updateMapSummaryText() {
                if (!elements.mapSummaryTitle || !elements.mapToggleBtn) return;
                elements.mapSummaryTitle.textContent = t("map");
                const isCollapsed = elements.regionMapSection.classList.contains("is-collapsed");
                elements.mapToggleBtn.textContent = isCollapsed ? t("mapShow") : t("mapHide");
                elements.mapToggleBtn.setAttribute("aria-expanded", (!isCollapsed).toString());
                if (!elements.mapSummaryTitle || !elements.mapSummaryToggle) return;
                elements.mapSummaryTitle.textContent = t("map");
                elements.mapSummaryToggle.textContent = elements.regionMapSection.open ? t("mapHide") : t("mapShow");
            }

            function updateTimeSelect() {
                const currentValue = elements.timeSelect.value || "any";
                elements.timeSelect.innerHTML = "";
                const options = [
                    { value: "any", label: t("timeAny") },
                    { value: "morning", label: t("timeMorning") },
                    { value: "afternoon", label: t("timeAfternoon") },
                    { value: "evening", label: t("timeEvening") },
                    { value: "late", label: t("timeLate") }
                ];
                options.forEach(function (opt) {
                    const option = document.createElement("option");
                    option.value = opt.value;
                    option.textContent = opt.label;
                    elements.timeSelect.appendChild(option);
                });
                elements.timeSelect.value = currentValue;
            }

            function updateRegionSelect() {
                const currentValue = elements.regionSelect.value || "all";
                const options = Array.from(elements.regionSelect.options);
                options.forEach(function (option) {
                    if (option.value === "all") {
                        option.textContent = t("regionAll");
                    } else {
                        option.textContent = getRegionName(option.value);
                    }
                });
                elements.regionSelect.value = currentValue;
            }

            function updateDateSelect() {
                const currentValue = elements.dateSelect.value || "all";
                const options = Array.from(elements.dateSelect.options);
                options.forEach(function (option) {
                    if (option.value === "all") {
                        option.textContent = t("dateAll");
                    } else {
                        option.textContent = formatDate(option.value, true);
                    }
                });
                elements.dateSelect.value = currentValue;
            }

            function getDefaultDateForView() {
                if (state.view === "film" && state.todayDate) {
                    return state.todayDate;
                }
                return "all";
            }

            function updateSortOptions() {
                const sortOptions = getSortOptions();
                const options = sortOptions[state.view];
                if (!options) {
                    elements.sortFilterContainer.classList.add("is-hidden");
                    return;
                }
                elements.sortFilterContainer.classList.remove("is-hidden");

                const currentValue = state.sort;
                elements.sortSelect.innerHTML = "";
                options.forEach(function (option) {
                    const optionEl = document.createElement("option");
                    optionEl.value = option.value;
                    optionEl.textContent = option.label;
                    elements.sortSelect.appendChild(optionEl);
                });
                const stillValid = options.some(function (option) {
                    return option.value === currentValue;
                });
                state.sort = stillValid ? currentValue : options[0].value;
                elements.sortSelect.value = state.sort;
            }

            function createElement(tag, className, text) {
                const element = document.createElement(tag);
                if (className) {
                    element.className = className;
                }
                if (text !== undefined) {
                    element.textContent = text;
                }
                return element;
            }

            function getJstDateText() {
                return new Intl.DateTimeFormat("en-CA", {
                    timeZone: "Asia/Tokyo",
                    year: "numeric",
                    month: "2-digit",
                    day: "2-digit"
                }).format(new Date());
            }

            function parseDate(dateText) {
                if (!dateText) return null;
                const date = new Date(dateText + "T00:00:00+09:00");
                if (Number.isNaN(date.getTime())) return null;
                return date;
            }

            function formatDate(dateText, longFormat) {
                const date = parseDate(dateText);
                if (!date) return dateText || "";
                return longFormat ? getLongDateFormatter().format(date) : getDateFormatter().format(date);
            }

            function getDateRange(showings) {
                const dates = showings.map(function (showing) {
                    return showing.dateText;
                }).filter(Boolean).sort();
                if (!dates.length) return "";
                if (dates[0] === dates[dates.length - 1]) {
                    return formatDate(dates[0], true);
                }
                return formatDate(dates[0], true) + " - " + formatDate(dates[dates.length - 1], true);
            }

            function timeToMinutes(timeText) {
                if (!timeText || !timeText.includes(":")) return null;
                const parts = timeText.split(":");
                const hours = parseInt(parts[0], 10);
                const minutes = parseInt(parts[1], 10);
                if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;
                return hours * 60 + minutes;
            }

            function parseDateTime(dateText, timeText) {
                if (!dateText) return null;
                const timeValue = timeText && timeText.includes(":") ? timeText : "00:00";
                const parts = timeValue.split(":");
                const hours = (parts[0] || "00").padStart(2, "0");
                const minutes = (parts[1] || "00").padStart(2, "0");
                const date = new Date(dateText + "T" + hours + ":" + minutes + ":00+09:00");
                if (Number.isNaN(date.getTime())) return null;
                return date;
            }

            function timeValue(date) {
                return date ? date.getTime() : Number.POSITIVE_INFINITY;
            }

            function compareShowings(a, b) {
                const aTime = timeValue(a.dateTime);
                const bTime = timeValue(b.dateTime);
                if (aTime !== bTime) {
                    return aTime - bTime;
                }
                return (a.showtime || "").localeCompare(b.showtime || "");
            }

            function normalizeTitle(title) {
                return (title || "")
                    .toLowerCase()
                    .replace(/[\[\]\(\)]/g, " ")
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/^-+|-+$/g, "");
            }

            function formatBilingual(primary, secondary) {
                if (!primary && !secondary) return "";
                if (!primary) return secondary;
                if (!secondary || secondary === primary) return primary;
                return primary + " (" + secondary + ")";
            }

            function buildLetterboxdUrl(title, tmdbId) {
                if (tmdbId) {
                    return "https://letterboxd.com/tmdb/" + tmdbId + "/";
                }
                const slug = normalizeTitle(title);
                return slug ? "https://letterboxd.com/film/" + slug + "/" : "";
            }

            function getCinemaJapaneseName(cinemaName) {
                return cinemaJapaneseNames[cinemaName] || cinemaName;
            }

            function buildMapsUrl(cinemaName) {
                const query = encodeURIComponent(getCinemaJapaneseName(cinemaName) + " 東京");
                return "https://www.google.com/maps/search/?api=1&query=" + query;
            }

            const cinemaWebsiteOverrides = {
                "下北沢トリウッド": "https://tollywood.jp/",
                "下高井戸シネマ": "https://shimotakaidocinema.com/",
                "ポレポレ東中野": "https://pole2.co.jp/"
            };
            const blockedHostSuffixes = [
                "ticketsource.co.uk",
                "admit-one.co.uk",
                "eigaland.com",
                "jorudan.co.jp",
                "hellomovie.info",
                "eiga.com"
            ];
            const blockedHosts = new Set([
                "tickets.barbican.org.uk",
                "bookings.thegardencinema.co.uk"
            ]);

            function isBlockedHost(host) {
                if (blockedHosts.has(host)) return true;
                return blockedHostSuffixes.some(function (suffix) {
                    return host.endsWith(suffix);
                });
            }

            function getCinemaWebsite(cinemaName, showings) {
                if (cinemaWebsiteOverrides[cinemaName]) return cinemaWebsiteOverrides[cinemaName];
                const counts = new Map();
                const origins = new Map();

                showings.forEach(function (showing) {
                    [showing.bookingUrl, showing.detailUrl].forEach(function (url) {
                        if (!url) return;
                        let parsed;
                        try {
                            parsed = new URL(url);
                        } catch (error) {
                            return;
                        }
                        const host = parsed.hostname.toLowerCase();
                        counts.set(host, (counts.get(host) || 0) + 1);
                        if (!origins.has(host)) origins.set(host, parsed.origin);
                    });
                });

                if (!counts.size) return "";

                function pickHost(skipBlocked) {
                    let bestHost = "";
                    let bestCount = -1;
                    counts.forEach(function (count, host) {
                        if (skipBlocked && isBlockedHost(host)) return;
                        if (count > bestCount) {
                            bestHost = host;
                            bestCount = count;
                        }
                    });
                    return bestHost;
                }

                const preferredHost = pickHost(true) || pickHost(false);
                if (!preferredHost) return "";
                return origins.get(preferredHost) || ("https://" + preferredHost);
            }

            function getImageUrl(path, size) {
                if (!path) return "";
                if (path.startsWith("http")) return path;
                return tmdbBase + size + path;
            }

            function buildFilterOptions(showings) {
                const todayText = getJstDateText();

                // Only include dates from today onwards
                const dates = Array.from(new Set(showings.map(function (showing) {
                    return showing.dateText;
                }).filter(function (dateText) {
                    return dateText && dateText >= todayText;
                }))).sort();

                state.todayDate = dates.includes(todayText) ? todayText : (dates[0] || "");
                state.filters.date = "all";

                elements.dateSelect.innerHTML = "";
                const allOption = document.createElement("option");
                allOption.value = "all";
                allOption.textContent = t("dateAll");
                elements.dateSelect.appendChild(allOption);

                dates.forEach(function (dateText) {
                    const option = document.createElement("option");
                    option.value = dateText;
                    option.textContent = formatDate(dateText, true);
                    elements.dateSelect.appendChild(option);
                });
                if (state.view === "film" && state.todayDate) {
                    state.filters.date = state.todayDate;
                }
                elements.dateSelect.value = state.filters.date || "all";

                const regions = Array.from(new Set(showings.map(function (showing) {
                    return showing.region;
                }).filter(Boolean)));
                const orderedRegions = cinemaCategories.map(function (category) {
                    return category.name;
                }).filter(function (region) {
                    return regions.includes(region);
                });
                regions.forEach(function (region) {
                    if (!orderedRegions.includes(region)) orderedRegions.push(region);
                });
                elements.regionSelect.innerHTML = "";
                const allRegionsOption = document.createElement("option");
                allRegionsOption.value = "all";
                allRegionsOption.textContent = t("regionAll");
                elements.regionSelect.appendChild(allRegionsOption);
                orderedRegions.forEach(function (region) {
                    const option = document.createElement("option");
                    option.value = region;
                    option.textContent = getRegionName(region);
                    elements.regionSelect.appendChild(option);
                });
                elements.regionSelect.value = state.filters.region || "all";

                updateSortOptions();
            }

            function normalizeShowings(rawData) {
                return rawData.map(function (item, index) {
                    const titleJp = item.clean_title_jp || item.movie_title || item.movie_title_en || t("untitled");
                    const titleEn = item.movie_title_en || "";
                    const titleDisplay = formatBilingual(titleJp, titleEn);
                    const tmdbId = item.tmdb_id ? String(item.tmdb_id) : "";
                    const rawCinemaName = item.cinema_name || t("unknownCinema");
                    const cinemaJp = getCinemaJapaneseName(rawCinemaName);
                    const region = getRegionForCinema(rawCinemaName);
                    const cinemaEn = cinemaEnglishNames[rawCinemaName] || "";
                    const cinemaDisplay = formatBilingual(cinemaJp, cinemaEn);
                    const dateText = item.date_text || "";
                    const showtime = item.showtime || "";
                    const runtimeRaw = item.runtime_min || item.runtime || "";
                    const runtime = parseInt(runtimeRaw, 10);
                    const genres = Array.isArray(item.genres) ? item.genres : [];
                    const genresEn = Array.isArray(item.genres_en) ? item.genres_en : [];
                    const tags = Array.isArray(item.tags) ? item.tags : [];

                    return {
                        id: index,
                        cinema: rawCinemaName,
                        region: region,
                        cinemaDisplay: cinemaDisplay,
                        cinemaJp: cinemaJp,
                        cinemaEn: cinemaEn,
                        titleJp: titleJp,
                        titleEn: titleEn,
                        titleDisplay: titleDisplay,
                        dateText: dateText,
                        showtime: showtime,
                        bookingUrl: item.booking_url || item.purchase_url || "",
                        detailUrl: item.detail_page_url || item.official_site || "",
                        director: item.director || "",
                        directorEn: item.director_en || "",
                        year: item.year || "",
                        runtime: Number.isFinite(runtime) ? runtime : "",
                        genres: genres,
                        genresEn: genresEn,
                        formatTags: tags,
                        rating: item.vote_average ? Number(item.vote_average) : 0,
                        posterPath: item.tmdb_poster_path || "",
                        backdropPath: item.tmdb_backdrop_path || "",
                        overview: item.synopsis || item.tmdb_overview_jp || "",
                        overviewEn: item.tmdb_overview_en || item.synopsis_en || "",
                        tmdbId: tmdbId,
                        letterboxdUrl: buildLetterboxdUrl(item.movie_title_en || item.movie_title || titleJp, tmdbId),
                        searchText: [
                            item.movie_title,
                            item.movie_title_en,
                            item.clean_title_jp,
                            item.program_title,
                            cinemaJp,
                            cinemaEn,
                            item.director,
                            item.director_en,
                            genres.join(" "),
                            genresEn.join(" "),
                            tags.join(" ")
                        ].filter(Boolean).join(" ").toLowerCase(),
                        dateTime: parseDateTime(dateText, showtime),
                        timeMinutes: timeToMinutes(showtime)
                    };
                });
            }

            function isDocumentary(showing) {
                const genres = [];
                if (Array.isArray(showing.genres)) genres.push.apply(genres, showing.genres);
                if (Array.isArray(showing.genresEn)) genres.push.apply(genres, showing.genresEn);
                return genres.some(function (genre) {
                    const value = String(genre || "").toLowerCase();
                    return value.includes("documentary") || value.includes("ドキュメンタリー");
                });
            }

            function applyFilters(showings) {
                const now = new Date();
                return showings.filter(function (showing) {
                    if (showing.timeMinutes !== null && showing.dateTime && showing.dateTime < now) {
                        return false;
                    }
                    if (state.filters.search && !showing.searchText.includes(state.filters.search)) {
                        return false;
                    }
                    if (state.filters.date !== "all" && showing.dateText !== state.filters.date) {
                        return false;
                    }
                    if (state.filters.time !== "any") {
                        if (showing.timeMinutes === null) return false;
                        if (state.filters.time === "morning" && showing.timeMinutes >= 12 * 60) return false;
                        if (state.filters.time === "afternoon" && (showing.timeMinutes < 12 * 60 || showing.timeMinutes >= 17 * 60)) return false;
                        if (state.filters.time === "evening" && (showing.timeMinutes < 17 * 60 || showing.timeMinutes >= 21 * 60)) return false;
                        if (state.filters.time === "late" && showing.timeMinutes < 21 * 60) return false;
                    }
                    if (state.filters.region !== "all" && showing.region !== state.filters.region) {
                        return false;
                    }
                    if (state.filters.docOnly && !isDocumentary(showing)) {
                        return false;
                    }
                    return true;
                });
            }

            function getFilmKey(showing) {
                const keyTitle = (showing.titleEn || showing.titleJp || showing.titleDisplay || "").trim();
                return showing.tmdbId ? "tmdb-" + showing.tmdbId : "title-" + keyTitle;
            }

            function groupByFilm(showings) {
                const map = new Map();
                showings.forEach(function (showing) {
                    const key = getFilmKey(showing);
                    if (!map.has(key)) {
                        map.set(key, {
                            key: key,
                            titleJp: showing.titleJp,
                            titleEn: showing.titleEn,
                            titleDisplay: showing.titleDisplay,
                            year: showing.year,
                            director: showing.director,
                            directorEn: showing.directorEn,
                            runtime: showing.runtime,
                            genres: showing.genres.slice(),
                            rating: showing.rating || 0,
                            overview: showing.overview,
                            posterPath: showing.posterPath,
                            formatTags: new Set(),
                            showings: [],
                            letterboxdUrl: showing.letterboxdUrl
                        });
                    }
                    const film = map.get(key);
                    film.showings.push(showing);
                    if (!film.year && showing.year) film.year = showing.year;
                    if (!film.director && showing.director) film.director = showing.director;
                    if (!film.directorEn && showing.directorEn) film.directorEn = showing.directorEn;
                    if (!film.runtime && showing.runtime) film.runtime = showing.runtime;
                    if (!film.overview && showing.overview) film.overview = showing.overview;
                    if (!film.overviewEn && showing.overviewEn) film.overviewEn = showing.overviewEn;
                    if (!film.posterPath && showing.posterPath) film.posterPath = showing.posterPath;
                    if (!film.titleEn && showing.titleEn) {
                        film.titleEn = showing.titleEn;
                        film.titleDisplay = formatBilingual(film.titleJp, film.titleEn);
                    }
                    if (showing.genres.length && !film.genres.length) film.genres = showing.genres.slice();
                    if (showing.rating > film.rating) film.rating = showing.rating;
                    if (!film.letterboxdUrl && showing.letterboxdUrl) film.letterboxdUrl = showing.letterboxdUrl;
                    showing.formatTags.forEach(function (tag) {
                        film.formatTags.add(tag);
                    });
                });

                const films = Array.from(map.values());
                films.forEach(function (film) {
                    film.showings.sort(compareShowings);
                    film.nextTime = film.showings.length ? timeValue(film.showings[0].dateTime) : Number.POSITIVE_INFINITY;
                    film.formatTags = Array.from(film.formatTags);
                });
                return films;
            }

            function getFiltersSummary() {
                const parts = [];
                if (state.filters.search) parts.push("検索: \"" + state.filters.search + "\" (Search)");
                if (state.filters.date !== "all") parts.push("日付: " + formatDate(state.filters.date, true) + " (Date)");
                if (state.filters.time !== "any") parts.push("時間帯: " + timeBucketLabels[state.filters.time]);
                if (state.filters.region !== "all") parts.push("地域: " + state.filters.region + " (Region)");
                if (state.filters.docOnly) parts.push(t("docOnly"));
                if (!parts.length) parts.push("フィルターなし (No filters applied)");
                return parts.join(" | ");
            }
            function renderCinemaIndex(showings) {
                elements.cinemaIndex.innerHTML = "";

                const cinemasMap = new Map();
                showings.forEach(function (showing) {
                    if (!cinemasMap.has(showing.cinema)) {
                        cinemasMap.set(showing.cinema, { name: showing.cinema, showings: [] });
                    }
                    cinemasMap.get(showing.cinema).showings.push(showing);
                });

                if (!cinemasMap.size) {
                    elements.cinemaIndex.appendChild(createElement("div", "empty-state", t("noCinemas")));
                    return;
                }

                let renderedBlocks = 0;
                cinemaCategories.forEach(function (category) {
                    const cinemas = category.cinemas.map(function (cinemaName) {
                        const cinema = cinemasMap.get(cinemaName);
                        return cinema ? { name: cinemaName, count: cinema.showings.length } : { name: cinemaName, count: 0 };
                    }).filter(function (cinema) {
                        return cinema.count > 0;
                    });

                    if (!cinemas.length) {
                        return;
                    }
                    renderedBlocks += 1;

                    const block = createElement("div", "region-block");
                    block.appendChild(createElement("h2", "region-title", getRegionName(category.name)));

                    const grid = createElement("div", "cinema-grid");
                    cinemas.forEach(function (cinema) {
                        const card = createElement("button", "cinema-card");
                        card.type = "button";
                        card.appendChild(createElement("div", "cinema-card-title", getCinemaDisplayName(cinema.name)));
                        card.addEventListener("click", function () {
                            state.selectedCinema = cinema.name;
                            render();
                            elements.cinemaShowtimes.scrollIntoView({ behavior: "smooth" });
                        });
                        grid.appendChild(card);
                    });

                    block.appendChild(grid);
                    elements.cinemaIndex.appendChild(block);
                });

                if (!renderedBlocks) {
                    elements.cinemaIndex.appendChild(createElement("div", "empty-state", t("noCinemas")));
                }
            }

            function renderCinemaShowtimes(showings) {
                elements.cinemaShowtimesList.innerHTML = "";
                elements.cinemaTitle.textContent = getCinemaDisplayName(state.selectedCinema);
                elements.cinemaMapLink.href = buildMapsUrl(state.selectedCinema);
                const allCinemaShowings = state.data.filter(function (showing) {
                    return showing.cinema === state.selectedCinema;
                });
                const cinemaWebsite = getCinemaWebsite(state.selectedCinema, allCinemaShowings.length ? allCinemaShowings : showings);
                if (cinemaWebsite) {
                    elements.cinemaSiteLink.href = cinemaWebsite;
                    elements.cinemaSiteLink.classList.remove("is-hidden");
                } else {
                    elements.cinemaSiteLink.classList.add("is-hidden");
                    elements.cinemaSiteLink.removeAttribute("href");
                }

                const range = getDateRange(showings);
                const metaParts = [];
                if (showings.length) metaParts.push(showings.length + " " + t("showings"));
                if (range) metaParts.push(range);
                elements.cinemaMeta.textContent = metaParts.join(" | ");

                if (!showings.length) {
                    elements.cinemaShowtimesList.appendChild(createElement("div", "empty-state", t("noShowings")));
                    return;
                }

                const byDate = new Map();
                showings.forEach(function (showing) {
                    const dateKey = showing.dateText || "日付不明 (Unknown date)";
                    if (!byDate.has(dateKey)) {
                        byDate.set(dateKey, []);
                    }
                    byDate.get(dateKey).push(showing);
                });

                Array.from(byDate.keys()).sort().forEach(function (dateKey) {
                    const group = createElement("div", "date-block");
                    group.appendChild(createElement("h3", "date-title", formatDate(dateKey, true)));

                    const filmMap = new Map();
                    byDate.get(dateKey).forEach(function (showing) {
                        const key = getFilmKey(showing);
                        if (!filmMap.has(key)) {
                            filmMap.set(key, {
                                titleDisplay: showing.titleDisplay,
                                year: showing.year,
                                director: showing.director,
                                runtime: showing.runtime,
                                letterboxdUrl: showing.letterboxdUrl,
                                showings: []
                            });
                        }
                        filmMap.get(key).showings.push(showing);
                    });

                    Array.from(filmMap.values()).forEach(function (film) {
                        film.showings.sort(compareShowings);
                        const row = createElement("div", "cinema-film");

                        const info = createElement("div");
                        const titleRow = createElement("div", "cinema-film-title");
                        titleRow.appendChild(createElement("span", null, getFilmDisplayTitle(film)));
                        if (film.letterboxdUrl) {
                            const letterboxd = createElement("a", "film-link", "Letterboxd");
                            letterboxd.href = film.letterboxdUrl;
                            letterboxd.target = "_blank";
                            letterboxd.rel = "noopener";
                            titleRow.appendChild(letterboxd);
                        }
                        info.appendChild(titleRow);

                        const metaParts = [];
                        if (film.year) metaParts.push(film.year);
                        var filmDirector = getFilmDirector(film);
                        if (filmDirector) metaParts.push(filmDirector);
                        if (film.runtime) metaParts.push(film.runtime + " " + t("min"));
                        if (metaParts.length) {
                            info.appendChild(createElement("div", "cinema-film-meta", metaParts.join(" | ")));
                        }

                        row.appendChild(info);

                        const timeRow = createElement("div", "time-row");
                        film.showings.forEach(function (showing) {
                            const label = showing.showtime || t("tbd");
                            if (showing.bookingUrl || showing.detailUrl) {
                                const link = createElement("a", "time-chip", label);
                                link.href = showing.bookingUrl || showing.detailUrl;
                                link.target = "_blank";
                                link.rel = "noopener";
                                if (showing.bookingUrl) {
                                    link.classList.add("is-bookable");
                                }
                                timeRow.appendChild(link);
                            } else {
                                timeRow.appendChild(createElement("span", "time-chip", label));
                            }
                        });
                        row.appendChild(timeRow);
                        group.appendChild(row);
                    });

                    elements.cinemaShowtimesList.appendChild(group);
                });
            }

            function renderCinemaView(showings) {
                elements.cinemaView.classList.remove("is-hidden");
                elements.filmView.classList.add("is-hidden");

                if (state.selectedCinema) {
                    elements.cinemaIndex.classList.add("is-hidden");
                    elements.cinemaShowtimes.classList.remove("is-hidden");
                    const cinemaShowings = showings.filter(function (showing) {
                        return showing.cinema === state.selectedCinema;
                    });
                    renderCinemaShowtimes(cinemaShowings);
                } else {
                    elements.cinemaShowtimes.classList.add("is-hidden");
                    elements.cinemaIndex.classList.remove("is-hidden");
                    renderCinemaIndex(showings);
                }
            }

            function renderFilmList(films, totalShowings) {
                elements.filmResultsCount.textContent = totalShowings + " " + t("showings") + " / " + films.length + " " + t("films");
                elements.filmResultsMeta.textContent = getFiltersSummary();

                const fragment = document.createDocumentFragment();
                films.forEach(function (film) {
                    const card = createElement("article", "film-card");

                    const poster = createElement("div", "film-poster", t("posterUnavailable"));
                    const posterUrl = getImageUrl(film.posterPath, "w342");
                    if (posterUrl) {
                        poster.style.backgroundImage = "url(\"" + posterUrl + "\")";
                        poster.style.backgroundSize = "cover";
                        poster.style.backgroundPosition = "center";
                        poster.textContent = "";
                    }
                    card.appendChild(poster);

                    const body = createElement("div", "film-body");
                    body.appendChild(createElement("h3", "film-title", getFilmDisplayTitle(film)));

                    const actions = createElement("div", "film-actions");
                    if (film.letterboxdUrl) {
                        const letterboxd = createElement("a", "film-link", "Letterboxd");
                        letterboxd.href = film.letterboxdUrl;
                        letterboxd.target = "_blank";
                        letterboxd.rel = "noopener";
                        actions.appendChild(letterboxd);
                    }
                    if (actions.childNodes.length) {
                        body.appendChild(actions);
                    }

                    const metaParts = [];
                    if (film.year) metaParts.push(film.year);
                    var filmDirector = getFilmDirector(film);
                    if (filmDirector) metaParts.push(filmDirector);
                    if (film.runtime) metaParts.push(film.runtime + " " + t("min"));
                    if (metaParts.length) {
                        body.appendChild(createElement("div", "film-meta", metaParts.join(" | ")));
                    }

                    var displayOverview = state.lang === "en" ? (film.overviewEn || film.overview) : film.overview;
                    if (displayOverview) {
                        body.appendChild(createElement("p", "film-blurb", displayOverview));
                    }

                    if (film.formatTags.length) {
                        const tagRow = createElement("div", "tag-row");
                        film.formatTags.forEach(function (tag) {
                            tagRow.appendChild(createElement("span", "tag", tag));
                        });
                        body.appendChild(tagRow);
                    }

                    const showingsByCinema = new Map();
                    film.showings.forEach(function (showing) {
                        if (!showingsByCinema.has(showing.cinema)) {
                            showingsByCinema.set(showing.cinema, []);
                        }
                        showingsByCinema.get(showing.cinema).push(showing);
                    });

                    showingsByCinema.forEach(function (showings, cinema) {
                        showings.sort(compareShowings);
                        const row = createElement("div", "showing-row");
                        row.appendChild(createElement("div", "cinema-name", getCinemaDisplayName(cinema)));

                        const timeRow = createElement("div", "time-row");
                        showings.forEach(function (showing) {
                            const includeDate = state.filters.date === "all";
                            const label = includeDate && showing.dateText
                                ? formatDate(showing.dateText, false) + " " + (showing.showtime || t("tbd"))
                                : (showing.showtime || t("tbd"));
                            if (showing.bookingUrl || showing.detailUrl) {
                                const link = createElement("a", "time-chip", label);
                                link.href = showing.bookingUrl || showing.detailUrl;
                                link.target = "_blank";
                                link.rel = "noopener";
                                if (showing.bookingUrl) {
                                    link.classList.add("is-bookable");
                                }
                                timeRow.appendChild(link);
                            } else {
                                timeRow.appendChild(createElement("span", "time-chip", label));
                            }
                        });
                        row.appendChild(timeRow);
                        body.appendChild(row);
                    });

                    card.appendChild(body);
                    fragment.appendChild(card);
                });

                elements.filmResultsList.appendChild(fragment);
            }

            function renderFilmView(showings) {
                elements.cinemaView.classList.add("is-hidden");
                elements.filmView.classList.remove("is-hidden");
                elements.filmResultsList.innerHTML = "";
                elements.filmEmpty.classList.add("is-hidden");
                elements.filmResultsMeta.textContent = getFiltersSummary();

                if (!showings.length) {
                    elements.filmResultsCount.textContent = "0件の上映 (0 showings)";
                    elements.filmEmpty.classList.remove("is-hidden");
                    return;
                }

                const films = groupByFilm(showings);
                if (state.sort === "soonest") {
                    films.sort(function (a, b) { return a.nextTime - b.nextTime; });
                } else if (state.sort === "release-new") {
                    films.sort(function (a, b) {
                        const yearA = parseInt(a.year, 10) || 0;
                        const yearB = parseInt(b.year, 10) || 0;
                        if (yearA !== yearB) return yearB - yearA;
                        return (a.titleDisplay || a.titleJp || a.titleEn || "").localeCompare(b.titleDisplay || b.titleJp || b.titleEn || "");
                    });
                } else if (state.sort === "release-old") {
                    films.sort(function (a, b) {
                        const yearA = parseInt(a.year, 10) || 9999;
                        const yearB = parseInt(b.year, 10) || 9999;
                        if (yearA !== yearB) return yearA - yearB;
                        return (a.titleDisplay || a.titleJp || a.titleEn || "").localeCompare(b.titleDisplay || b.titleJp || b.titleEn || "");
                    });
                } else {
                    films.sort(function (a, b) { return a.nextTime - b.nextTime; });
                }

                renderFilmList(films, showings.length);
            }

            function updateRegionMap() {
                // Update selected state for each region area
                elements.regionAreas.forEach(function (area) {
                    const region = area.getAttribute("data-region");
                    const isSelected = state.filters.region === region;
                    area.classList.toggle("is-selected", isSelected);

                    // Update cinema count for this region
                    const countEl = area.querySelector(".region-count");
                    if (countEl) {
                        const cinemaCount = cinemaCategories.find(function (cat) {
                            return cat.name === region;
                        });
                        if (cinemaCount) {
                            const count = cinemaCount.cinemas.length;
                            countEl.textContent = count + " " + t("mapCinemaCount");
                        }
                    }
                });

                // Show/hide reset button based on whether a region is selected
                const hasSelection = state.filters.region !== "all";
                elements.mapResetBtn.classList.toggle("is-hidden", !hasSelection);
                elements.mapResetBtn.textContent = t("mapReset");
            }

            function render() {
                const filtered = applyFilters(state.data);
                updateRegionMap();
                if (state.view === "film") {
                    renderFilmView(filtered);
                } else {
                    renderCinemaView(filtered);
                }
            }

            function fetchShowtimes() {
                fetch(jsonUrl + "?t=" + Date.now(), { cache: "no-store" })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error("HTTP error " + response.status);
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        const todayText = getJstDateText();
                        state.data = normalizeShowings(data).filter(function (showing) {
                            return showing.dateText >= todayText;
                        });
                        buildFilterOptions(state.data);
                        render();
                    })
                    .catch(function () {
                        elements.cinemaIndex.innerHTML = "";
                        elements.cinemaIndex.appendChild(createElement("div", "loading", t("loadError")));
                        elements.filmResultsList.innerHTML = "";
                        elements.filmResultsList.appendChild(createElement("div", "loading", t("loadError")));
                    });
            }

            // Initialize language button state and UI text
            elements.langButtons.forEach(function (button) {
                const isActive = button.getAttribute("data-lang") === state.lang;
                button.classList.toggle("is-active", isActive);
            });
            updateUIText();
            updateTimeSelect();

            fetchShowtimes();
        });
    </script>
</body>
</html>
